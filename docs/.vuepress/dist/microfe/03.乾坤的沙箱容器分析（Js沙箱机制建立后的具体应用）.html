<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.53">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?3ada78bd736d6c32ac7d2e900e4e3d9d";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();</script><link rel="icon" href="/images/developer.jpeg"><title>03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用） | 杨艺韬讲堂</title><meta name="description" content="杨艺韬讲堂, 杨艺韬, Adam Yang, react18, React, vue3, 源码, 前端">
    <link rel="preload" href="/assets/style.512c328e.css" as="style" /><link rel="stylesheet" href="/assets/style.512c328e.css" />
    <link rel="modulepreload" href="/assets/app.c996eb5c.js"><link rel="modulepreload" href="/assets/03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）.html.548c5f68.js"><link rel="modulepreload" href="/assets/03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）.html.3d13d503.js"><link rel="prefetch" href="/assets/index.html.169c1189.js" as="script" /><link rel="prefetch" href="/assets/README_en.html.284d9689.js" as="script" /><link rel="prefetch" href="/assets/index.html.bba26bdf.js" as="script" /><link rel="prefetch" href="/assets/01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱）.html.58370679.js" as="script" /><link rel="prefetch" href="/assets/02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现).html.0d8c0575.js" as="script" /><link rel="prefetch" href="/assets/04.乾坤的资源加载机制(import-html-entry的内部实现).html.92a85075.js" as="script" /><link rel="prefetch" href="/assets/05.乾坤loadMicroApp方法实现以及数据通信机制分析.html.e159d950.js" as="script" /><link rel="prefetch" href="/assets/06.single-spa的注册机制.html.1e86d052.js" as="script" /><link rel="prefetch" href="/assets/07.对single-spa的路由管理及微应用状态管理的分析.html.850dc54e.js" as="script" /><link rel="prefetch" href="/assets/08.single-spa中的reroute函数.html.dc26bab2.js" as="script" /><link rel="prefetch" href="/assets/index.html.68f323cd.js" as="script" /><link rel="prefetch" href="/assets/index.html.5b38e8b9.js" as="script" /><link rel="prefetch" href="/assets/01.代码管理策略-monorepo.html.d2d577b6.js" as="script" /><link rel="prefetch" href="/assets/02.项目构建流程和源码调试方法.html.33eb6ed9.js" as="script" /><link rel="prefetch" href="/assets/03.Vue3响应式核心原理.html.1cd6ecba.js" as="script" /><link rel="prefetch" href="/assets/04.Vue3响应式系统源码实现1.html.90173631.js" as="script" /><link rel="prefetch" href="/assets/05.Vue3响应式系统源码实现2.html.c18f024a.js" as="script" /><link rel="prefetch" href="/assets/06.reactive、ref相关api源码实现.html.f1ada482.js" as="script" /><link rel="prefetch" href="/assets/07.故事要从createApp讲起.html.6dae10d0.js" as="script" /><link rel="prefetch" href="/assets/08.虚拟Node到真实Node的路其实很长.html.34502cd7.js" as="script" /><link rel="prefetch" href="/assets/09.组件渲染和更新流程.html.e67daf6b.js" as="script" /><link rel="prefetch" href="/assets/10.名动江湖的diff算法.html.844ae1a8.js" as="script" /><link rel="prefetch" href="/assets/11.编译优化之Block Tree 与 PatchFlags.html.5736a5a6.js" as="script" /><link rel="prefetch" href="/assets/12.编译过程介绍及分析模版AST的生成过程.html.5647b4a3.js" as="script" /><link rel="prefetch" href="/assets/13.从AST到render函数（transform与代码生成）.html.e51e34f5.js" as="script" /><link rel="prefetch" href="/assets/index.html.e7f880cd.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.83c991ec.js" as="script" /><link rel="prefetch" href="/assets/02.树立正确的源码观.html.fb13da14.js" as="script" /><link rel="prefetch" href="/assets/03.React是什么.html.8ab59fb0.js" as="script" /><link rel="prefetch" href="/assets/04.React架构演进过程.html.393e1a6f.js" as="script" /><link rel="prefetch" href="/assets/05.树立数据结构与算法的意识.html.ca13f42a.js" as="script" /><link rel="prefetch" href="/assets/06.树立用原子视角看问题的意识.html.d0de50fb.js" as="script" /><link rel="prefetch" href="/assets/07.React18源码学习方法.html.4c3ab811.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.22395461.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.21cf1d16.js" as="script" /><link rel="prefetch" href="/assets/03.虚拟DOM与真实DOM的实况对比.html.559bb4a0.js" as="script" /><link rel="prefetch" href="/assets/04.JSX相关概念和原理.html.06fcc809.js" as="script" /><link rel="prefetch" href="/assets/05.React和ReactDOM职责划分.html.33c9e328.js" as="script" /><link rel="prefetch" href="/assets/06.createElement代码实现.html.0456a944.js" as="script" /><link rel="prefetch" href="/assets/07.实现 render、mount 和 createDOM进行初次渲染.html.41543d69.js" as="script" /><link rel="prefetch" href="/assets/08.实现函数setPropsForDOM为DOM设置属性.html.37d884ac.js" as="script" /><link rel="prefetch" href="/assets/09.调试初始化渲染过程.html.e76fd42c.js" as="script" /><link rel="prefetch" href="/assets/10.思考题与解答.html.6ed61faa.js" as="script" /><link rel="prefetch" href="/assets/11.本章小结.html.f91c6139.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.b5f266a9.js" as="script" /><link rel="prefetch" href="/assets/02.函数组件与类组件介绍.html.2c4a5a13.js" as="script" /><link rel="prefetch" href="/assets/03.实现函数组件基础功能.html.b9da3afc.js" as="script" /><link rel="prefetch" href="/assets/04.实现类组件基础功能.html.69a246c3.js" as="script" /><link rel="prefetch" href="/assets/05.类组件的更新机制分析.html.19428106.js" as="script" /><link rel="prefetch" href="/assets/06.实现类组件的setState方法.html.8e46262c.js" as="script" /><link rel="prefetch" href="/assets/07.事件合成机制原理分析.html.830bf124.js" as="script" /><link rel="prefetch" href="/assets/08.事件合成机制的简单实现.html.37ae6cb4.js" as="script" /><link rel="prefetch" href="/assets/09.ref的原理分析.html.64825db1.js" as="script" /><link rel="prefetch" href="/assets/10.类组件的ref源码实现.html.2d266ccd.js" as="script" /><link rel="prefetch" href="/assets/11.引入forwardRef的底层逻辑.html.80288dc9.js" as="script" /><link rel="prefetch" href="/assets/12.实现forwardRef为函数组件提供ref的能力.html.7b832146.js" as="script" /><link rel="prefetch" href="/assets/13.调试函数组件与类组件相关代码.html.c5318fc6.js" as="script" /><link rel="prefetch" href="/assets/14.思考题与解答.html.e29d1ced.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.0a37d66d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.0109b860.js" as="script" /><link rel="prefetch" href="/assets/02.生命周期的内涵.html.fede1a71.js" as="script" /><link rel="prefetch" href="/assets/03.生命周期图观察.html.974682b4.js" as="script" /><link rel="prefetch" href="/assets/04.常用生命周期函数应用案例.html.58f4fa8d.js" as="script" /><link rel="prefetch" href="/assets/05.常用生命周期函数源码实现.html.f2204171.js" as="script" /><link rel="prefetch" href="/assets/06.shouldComponentUpdate案例.html.dcef12d5.js" as="script" /><link rel="prefetch" href="/assets/07.shouldComponentUpdate实现.html.3755b6c4.js" as="script" /><link rel="prefetch" href="/assets/08.getDeriveStateFromProp案例.html.8a1252bb.js" as="script" /><link rel="prefetch" href="/assets/09.getDeriveStateFromProps源码实现.html.9db4f077.js" as="script" /><link rel="prefetch" href="/assets/10.getSnapshotBeforeUpdate应用案例.html.071a1bd9.js" as="script" /><link rel="prefetch" href="/assets/11.getSnapshotBeforeUpdate源码实现.html.cfa8ce6c.js" as="script" /><link rel="prefetch" href="/assets/12.生命周期相关代码调试.html.17603927.js" as="script" /><link rel="prefetch" href="/assets/13.思考题及解答.html.a7f21ab0.js" as="script" /><link rel="prefetch" href="/assets/14.本章小结.html.bcba6af3.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.5c56ed55.js" as="script" /><link rel="prefetch" href="/assets/02.React DOM DIFF原理.html.c06333b9.js" as="script" /><link rel="prefetch" href="/assets/03.React DOM DIFF算法源码实现.html.a92af391.js" as="script" /><link rel="prefetch" href="/assets/04.调试DOM DIFF算法.html.a39f906a.js" as="script" /><link rel="prefetch" href="/assets/05.思考题及解答.html.a964dca8.js" as="script" /><link rel="prefetch" href="/assets/06.本章小结.html.9f3b6ec7.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.93f955bf.js" as="script" /><link rel="prefetch" href="/assets/02.Hooks存在的意义.html.99f853db.js" as="script" /><link rel="prefetch" href="/assets/03.useState应用案例.html.7a27c44c.js" as="script" /><link rel="prefetch" href="/assets/04.useState源码实现.html.b6770829.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer应用案例.html.18c8d25e.js" as="script" /><link rel="prefetch" href="/assets/06.useReducer源码实现.html.e02afb3e.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect及useLayoutEffect应用案例.html.6d954f40.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect及useLayoutEffect源码实现.html.c7da98a1.js" as="script" /><link rel="prefetch" href="/assets/09.useRef应用案例及源码实现.html.83fab4fd.js" as="script" /><link rel="prefetch" href="/assets/10.useImperativeHandle应用案例及源码实现.html.b6a790ea.js" as="script" /><link rel="prefetch" href="/assets/11.useMemo及useCallback应用案例.html.01058c5f.js" as="script" /><link rel="prefetch" href="/assets/12.useMemo及useCallback源码实现.html.6fdcbe57.js" as="script" /><link rel="prefetch" href="/assets/13.Hooks相关源码调试.html.87195cff.js" as="script" /><link rel="prefetch" href="/assets/14.思考题及解答.html.1bd5bf45.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.d89b82e8.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.ad1b676f.js" as="script" /><link rel="prefetch" href="/assets/02.PureComponent应用案例.html.29c8f991.js" as="script" /><link rel="prefetch" href="/assets/03.PureComponent源码实现.html.74ae40b9.js" as="script" /><link rel="prefetch" href="/assets/04.memo应用案例.html.3ef4e9fe.js" as="script" /><link rel="prefetch" href="/assets/05.memo源码实现.html.9486e679.js" as="script" /><link rel="prefetch" href="/assets/06.调试PureComponent及memo相关的代码.html.b627d26b.js" as="script" /><link rel="prefetch" href="/assets/07.思考题及解答.html.30aff959.js" as="script" /><link rel="prefetch" href="/assets/08.本章小结.html.ed797777.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.d46d0437.js" as="script" /><link rel="prefetch" href="/assets/02.为什么需要Fiber架构.html.d180591d.js" as="script" /><link rel="prefetch" href="/assets/03.Fiber架构是什么.html.54fe6f6c.js" as="script" /><link rel="prefetch" href="/assets/04.Fiber是什么.html.f784bba3.js" as="script" /><link rel="prefetch" href="/assets/05.双缓冲策略.html.2e651b1f.js" as="script" /><link rel="prefetch" href="/assets/06.什么是工作循环.html.59fe3cee.js" as="script" /><link rel="prefetch" href="/assets/07.什么是并发模式.html.7e908706.js" as="script" /><link rel="prefetch" href="/assets/08.思考题及解答.html.2cb70c22.js" as="script" /><link rel="prefetch" href="/assets/09.小结.html.d925967a.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c871d2e2.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.6ea9422d.js" as="script" /><link rel="prefetch" href="/assets/03.jsx代码实现.html.2d6a50ab.js" as="script" /><link rel="prefetch" href="/assets/04.createRoot.html.2614bca8.js" as="script" /><link rel="prefetch" href="/assets/05.render函数的阶段划分.html.f47defce.js" as="script" /><link rel="prefetch" href="/assets/06.beginWork.html.77aa0a61.js" as="script" /><link rel="prefetch" href="/assets/07.completeWork.html.8e252c3c.js" as="script" /><link rel="prefetch" href="/assets/08.commitWork.html.41fa9bde.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.2c9c92bc.js" as="script" /><link rel="prefetch" href="/assets/10.函数组件的初始化.html.013cf3e2.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.f6bb4986.js" as="script" /><link rel="prefetch" href="/assets/12.小结.html.2bb91b5e.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.0ada0da1.js" as="script" /><link rel="prefetch" href="/assets/02.useReducer挂载.html.9199073b.js" as="script" /><link rel="prefetch" href="/assets/03.useReducer触发更新.html.74a19eee.js" as="script" /><link rel="prefetch" href="/assets/04.useReducer更新渲染1.html.9fc04de4.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer更新渲染2.html.4bc6a7ed.js" as="script" /><link rel="prefetch" href="/assets/06.useState源码实现.html.7865f484.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect挂载实现.html.d35c82a4.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect更新实现.html.72b52a42.js" as="script" /><link rel="prefetch" href="/assets/09.useLayoutEffect源码实现.html.13881dac.js" as="script" /><link rel="prefetch" href="/assets/10.代码调试.html.da8e9233.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.5cec2d5b.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.e878169d.js" as="script" /><link rel="prefetch" href="/assets/02.domdiff思路分析.html.ff56b49e.js" as="script" /><link rel="prefetch" href="/assets/03.单节点domdiff.html.b087761c.js" as="script" /><link rel="prefetch" href="/assets/04.多节点domdiff.html.44e670a7.js" as="script" /><link rel="prefetch" href="/assets/05.思考题.html.f1f6116d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.4ec62a06.js" as="script" /><link rel="prefetch" href="/assets/02.事件系统实现思路分析.html.8d98d6cb.js" as="script" /><link rel="prefetch" href="/assets/03.事件名注册.html.256c44ef.js" as="script" /><link rel="prefetch" href="/assets/04.注册监听事件.html.32e87da2.js" as="script" /><link rel="prefetch" href="/assets/05.派发事件的主要逻辑.html.cd6fd3b2.js" as="script" /><link rel="prefetch" href="/assets/06.收集注册的函数.html.08594967.js" as="script" /><link rel="prefetch" href="/assets/07.合成事件.html.67c4f89b.js" as="script" /><link rel="prefetch" href="/assets/08.注册事件的回调.html.be697f66.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.791e76ea.js" as="script" /><link rel="prefetch" href="/assets/10.思考题.html.17a524d5.js" as="script" /><link rel="prefetch" href="/assets/11.小结.html.7f324403.js" as="script" /><link rel="prefetch" href="/assets/introduction.html.6859cccd.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.eca6cfe8.js" as="script" /><link rel="prefetch" href="/assets/02.二进制基础计算.html.bc129849.js" as="script" /><link rel="prefetch" href="/assets/03.最小堆算法.html.3f81952c.js" as="script" /><link rel="prefetch" href="/assets/04.React18的优先级体系.html.866eda4c.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.d8648cd3.js" as="script" /><link rel="prefetch" href="/assets/02.调度核心逻辑.html.0ca7ccee.js" as="script" /><link rel="prefetch" href="/assets/03.任务优先级与事件优先级.html.200dfaed.js" as="script" /><link rel="prefetch" href="/assets/04.lane模型下的更新队列.html.56c76bd7.js" as="script" /><link rel="prefetch" href="/assets/05.加入优先级的初始化渲染.html.7d586f05.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c07c856d.js" as="script" /><link rel="prefetch" href="/assets/02.同步渲染.html.2303e51a.js" as="script" /><link rel="prefetch" href="/assets/03.并发渲染.html.b2ddab47.js" as="script" /><link rel="prefetch" href="/assets/04.思考题.html.a1920c62.js" as="script" /><link rel="prefetch" href="/assets/404.html.c3e557d0.js" as="script" /><link rel="prefetch" href="/assets/index.html.c377b301.js" as="script" /><link rel="prefetch" href="/assets/README_en.html.2a4c0116.js" as="script" /><link rel="prefetch" href="/assets/index.html.0b4b66ed.js" as="script" /><link rel="prefetch" href="/assets/01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱）.html.bd7276b8.js" as="script" /><link rel="prefetch" href="/assets/02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现).html.521c5aec.js" as="script" /><link rel="prefetch" href="/assets/04.乾坤的资源加载机制(import-html-entry的内部实现).html.4eac1176.js" as="script" /><link rel="prefetch" href="/assets/05.乾坤loadMicroApp方法实现以及数据通信机制分析.html.a4841ad5.js" as="script" /><link rel="prefetch" href="/assets/06.single-spa的注册机制.html.6bf50ea4.js" as="script" /><link rel="prefetch" href="/assets/07.对single-spa的路由管理及微应用状态管理的分析.html.5d74002d.js" as="script" /><link rel="prefetch" href="/assets/08.single-spa中的reroute函数.html.03d67412.js" as="script" /><link rel="prefetch" href="/assets/index.html.464fdcbd.js" as="script" /><link rel="prefetch" href="/assets/index.html.48d83e80.js" as="script" /><link rel="prefetch" href="/assets/01.代码管理策略-monorepo.html.fec92d7a.js" as="script" /><link rel="prefetch" href="/assets/02.项目构建流程和源码调试方法.html.7e589252.js" as="script" /><link rel="prefetch" href="/assets/03.Vue3响应式核心原理.html.11c3dfac.js" as="script" /><link rel="prefetch" href="/assets/04.Vue3响应式系统源码实现1.html.c693bb5e.js" as="script" /><link rel="prefetch" href="/assets/05.Vue3响应式系统源码实现2.html.e78d1677.js" as="script" /><link rel="prefetch" href="/assets/06.reactive、ref相关api源码实现.html.4b0dc475.js" as="script" /><link rel="prefetch" href="/assets/07.故事要从createApp讲起.html.0c5db6db.js" as="script" /><link rel="prefetch" href="/assets/08.虚拟Node到真实Node的路其实很长.html.455d1ee4.js" as="script" /><link rel="prefetch" href="/assets/09.组件渲染和更新流程.html.725d99f8.js" as="script" /><link rel="prefetch" href="/assets/10.名动江湖的diff算法.html.dba3d256.js" as="script" /><link rel="prefetch" href="/assets/11.编译优化之Block Tree 与 PatchFlags.html.f7f0aaf5.js" as="script" /><link rel="prefetch" href="/assets/12.编译过程介绍及分析模版AST的生成过程.html.d35da681.js" as="script" /><link rel="prefetch" href="/assets/13.从AST到render函数（transform与代码生成）.html.254f8ef0.js" as="script" /><link rel="prefetch" href="/assets/index.html.34516911.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.34c1ae89.js" as="script" /><link rel="prefetch" href="/assets/02.树立正确的源码观.html.146b6584.js" as="script" /><link rel="prefetch" href="/assets/03.React是什么.html.b99f83e2.js" as="script" /><link rel="prefetch" href="/assets/04.React架构演进过程.html.adf070aa.js" as="script" /><link rel="prefetch" href="/assets/05.树立数据结构与算法的意识.html.c459f609.js" as="script" /><link rel="prefetch" href="/assets/06.树立用原子视角看问题的意识.html.8d6196f0.js" as="script" /><link rel="prefetch" href="/assets/07.React18源码学习方法.html.db5e8368.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.021552a9.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.b50905c0.js" as="script" /><link rel="prefetch" href="/assets/03.虚拟DOM与真实DOM的实况对比.html.f798c741.js" as="script" /><link rel="prefetch" href="/assets/04.JSX相关概念和原理.html.f70bfe21.js" as="script" /><link rel="prefetch" href="/assets/05.React和ReactDOM职责划分.html.599b280e.js" as="script" /><link rel="prefetch" href="/assets/06.createElement代码实现.html.74549b80.js" as="script" /><link rel="prefetch" href="/assets/07.实现 render、mount 和 createDOM进行初次渲染.html.c688e61e.js" as="script" /><link rel="prefetch" href="/assets/08.实现函数setPropsForDOM为DOM设置属性.html.0fab75c7.js" as="script" /><link rel="prefetch" href="/assets/09.调试初始化渲染过程.html.4b457f15.js" as="script" /><link rel="prefetch" href="/assets/10.思考题与解答.html.1cfbfead.js" as="script" /><link rel="prefetch" href="/assets/11.本章小结.html.f860dc7e.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.877fec5f.js" as="script" /><link rel="prefetch" href="/assets/02.函数组件与类组件介绍.html.96af0c51.js" as="script" /><link rel="prefetch" href="/assets/03.实现函数组件基础功能.html.be971135.js" as="script" /><link rel="prefetch" href="/assets/04.实现类组件基础功能.html.9c5d7e7a.js" as="script" /><link rel="prefetch" href="/assets/05.类组件的更新机制分析.html.ccb148cd.js" as="script" /><link rel="prefetch" href="/assets/06.实现类组件的setState方法.html.755818fc.js" as="script" /><link rel="prefetch" href="/assets/07.事件合成机制原理分析.html.a75b7868.js" as="script" /><link rel="prefetch" href="/assets/08.事件合成机制的简单实现.html.4fd488ab.js" as="script" /><link rel="prefetch" href="/assets/09.ref的原理分析.html.10f38555.js" as="script" /><link rel="prefetch" href="/assets/10.类组件的ref源码实现.html.31e139ba.js" as="script" /><link rel="prefetch" href="/assets/11.引入forwardRef的底层逻辑.html.13649e3c.js" as="script" /><link rel="prefetch" href="/assets/12.实现forwardRef为函数组件提供ref的能力.html.d6502bbb.js" as="script" /><link rel="prefetch" href="/assets/13.调试函数组件与类组件相关代码.html.85dcfdc3.js" as="script" /><link rel="prefetch" href="/assets/14.思考题与解答.html.941a5163.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.e39a474d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.d7c3d864.js" as="script" /><link rel="prefetch" href="/assets/02.生命周期的内涵.html.2f0cd8f0.js" as="script" /><link rel="prefetch" href="/assets/03.生命周期图观察.html.ad68d0f1.js" as="script" /><link rel="prefetch" href="/assets/04.常用生命周期函数应用案例.html.1aff20c5.js" as="script" /><link rel="prefetch" href="/assets/05.常用生命周期函数源码实现.html.3b6899a2.js" as="script" /><link rel="prefetch" href="/assets/06.shouldComponentUpdate案例.html.8d0fa89f.js" as="script" /><link rel="prefetch" href="/assets/07.shouldComponentUpdate实现.html.da4623ad.js" as="script" /><link rel="prefetch" href="/assets/08.getDeriveStateFromProp案例.html.c9bd9709.js" as="script" /><link rel="prefetch" href="/assets/09.getDeriveStateFromProps源码实现.html.9c5aa323.js" as="script" /><link rel="prefetch" href="/assets/10.getSnapshotBeforeUpdate应用案例.html.bfcc961f.js" as="script" /><link rel="prefetch" href="/assets/11.getSnapshotBeforeUpdate源码实现.html.e8b20271.js" as="script" /><link rel="prefetch" href="/assets/12.生命周期相关代码调试.html.e1dfb27f.js" as="script" /><link rel="prefetch" href="/assets/13.思考题及解答.html.97614d72.js" as="script" /><link rel="prefetch" href="/assets/14.本章小结.html.c15a6c0b.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.1815a968.js" as="script" /><link rel="prefetch" href="/assets/02.React DOM DIFF原理.html.f54f904d.js" as="script" /><link rel="prefetch" href="/assets/03.React DOM DIFF算法源码实现.html.e456ed5e.js" as="script" /><link rel="prefetch" href="/assets/04.调试DOM DIFF算法.html.775fa554.js" as="script" /><link rel="prefetch" href="/assets/05.思考题及解答.html.feb5f33f.js" as="script" /><link rel="prefetch" href="/assets/06.本章小结.html.810c8f35.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c23acfce.js" as="script" /><link rel="prefetch" href="/assets/02.Hooks存在的意义.html.bc68541b.js" as="script" /><link rel="prefetch" href="/assets/03.useState应用案例.html.4d168a3e.js" as="script" /><link rel="prefetch" href="/assets/04.useState源码实现.html.3112b2c1.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer应用案例.html.d8ce7931.js" as="script" /><link rel="prefetch" href="/assets/06.useReducer源码实现.html.bd8df1bb.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect及useLayoutEffect应用案例.html.4033a3a2.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect及useLayoutEffect源码实现.html.b513813a.js" as="script" /><link rel="prefetch" href="/assets/09.useRef应用案例及源码实现.html.5eb5d9f3.js" as="script" /><link rel="prefetch" href="/assets/10.useImperativeHandle应用案例及源码实现.html.a817c595.js" as="script" /><link rel="prefetch" href="/assets/11.useMemo及useCallback应用案例.html.c92678b3.js" as="script" /><link rel="prefetch" href="/assets/12.useMemo及useCallback源码实现.html.a204cc10.js" as="script" /><link rel="prefetch" href="/assets/13.Hooks相关源码调试.html.41fed7f1.js" as="script" /><link rel="prefetch" href="/assets/14.思考题及解答.html.f09b91ec.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.eddf8676.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.31276e45.js" as="script" /><link rel="prefetch" href="/assets/02.PureComponent应用案例.html.ce02bdaa.js" as="script" /><link rel="prefetch" href="/assets/03.PureComponent源码实现.html.9f839b4f.js" as="script" /><link rel="prefetch" href="/assets/04.memo应用案例.html.150fd6b1.js" as="script" /><link rel="prefetch" href="/assets/05.memo源码实现.html.4e54c64f.js" as="script" /><link rel="prefetch" href="/assets/06.调试PureComponent及memo相关的代码.html.00997c78.js" as="script" /><link rel="prefetch" href="/assets/07.思考题及解答.html.15822cb9.js" as="script" /><link rel="prefetch" href="/assets/08.本章小结.html.67376bae.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.5772f085.js" as="script" /><link rel="prefetch" href="/assets/02.为什么需要Fiber架构.html.98df0921.js" as="script" /><link rel="prefetch" href="/assets/03.Fiber架构是什么.html.7a04c828.js" as="script" /><link rel="prefetch" href="/assets/04.Fiber是什么.html.f4e22c52.js" as="script" /><link rel="prefetch" href="/assets/05.双缓冲策略.html.5105c1d2.js" as="script" /><link rel="prefetch" href="/assets/06.什么是工作循环.html.10afa334.js" as="script" /><link rel="prefetch" href="/assets/07.什么是并发模式.html.657eacf3.js" as="script" /><link rel="prefetch" href="/assets/08.思考题及解答.html.11dbfd04.js" as="script" /><link rel="prefetch" href="/assets/09.小结.html.21764d75.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.54976df1.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.2f63d36f.js" as="script" /><link rel="prefetch" href="/assets/03.jsx代码实现.html.3222adf1.js" as="script" /><link rel="prefetch" href="/assets/04.createRoot.html.392ef4c4.js" as="script" /><link rel="prefetch" href="/assets/05.render函数的阶段划分.html.ce8536d2.js" as="script" /><link rel="prefetch" href="/assets/06.beginWork.html.4ff4b201.js" as="script" /><link rel="prefetch" href="/assets/07.completeWork.html.7f364827.js" as="script" /><link rel="prefetch" href="/assets/08.commitWork.html.d0a06b13.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.e2571c4c.js" as="script" /><link rel="prefetch" href="/assets/10.函数组件的初始化.html.81a0af66.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.49565c23.js" as="script" /><link rel="prefetch" href="/assets/12.小结.html.6c1a237c.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.674fa386.js" as="script" /><link rel="prefetch" href="/assets/02.useReducer挂载.html.8d1b3745.js" as="script" /><link rel="prefetch" href="/assets/03.useReducer触发更新.html.fbcc64f3.js" as="script" /><link rel="prefetch" href="/assets/04.useReducer更新渲染1.html.5a102db9.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer更新渲染2.html.f7a98f4f.js" as="script" /><link rel="prefetch" href="/assets/06.useState源码实现.html.386d6f98.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect挂载实现.html.be11f8bd.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect更新实现.html.a79a2762.js" as="script" /><link rel="prefetch" href="/assets/09.useLayoutEffect源码实现.html.44a4ac3d.js" as="script" /><link rel="prefetch" href="/assets/10.代码调试.html.058b3e84.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.6cda36ba.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.f66e8ec1.js" as="script" /><link rel="prefetch" href="/assets/02.domdiff思路分析.html.d025dfba.js" as="script" /><link rel="prefetch" href="/assets/03.单节点domdiff.html.a9790b82.js" as="script" /><link rel="prefetch" href="/assets/04.多节点domdiff.html.ea0468ae.js" as="script" /><link rel="prefetch" href="/assets/05.思考题.html.25cfa76d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.e498eea1.js" as="script" /><link rel="prefetch" href="/assets/02.事件系统实现思路分析.html.99a0a21e.js" as="script" /><link rel="prefetch" href="/assets/03.事件名注册.html.86a33918.js" as="script" /><link rel="prefetch" href="/assets/04.注册监听事件.html.3e201955.js" as="script" /><link rel="prefetch" href="/assets/05.派发事件的主要逻辑.html.55c3d750.js" as="script" /><link rel="prefetch" href="/assets/06.收集注册的函数.html.71ae39c0.js" as="script" /><link rel="prefetch" href="/assets/07.合成事件.html.e12718f6.js" as="script" /><link rel="prefetch" href="/assets/08.注册事件的回调.html.dad435f3.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.73b5aedf.js" as="script" /><link rel="prefetch" href="/assets/10.思考题.html.c2a6f47d.js" as="script" /><link rel="prefetch" href="/assets/11.小结.html.32befc51.js" as="script" /><link rel="prefetch" href="/assets/introduction.html.1b259e00.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.f92ede14.js" as="script" /><link rel="prefetch" href="/assets/02.二进制基础计算.html.de38cd43.js" as="script" /><link rel="prefetch" href="/assets/03.最小堆算法.html.861bf065.js" as="script" /><link rel="prefetch" href="/assets/04.React18的优先级体系.html.c54b4742.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.e0821a94.js" as="script" /><link rel="prefetch" href="/assets/02.调度核心逻辑.html.f030a1c5.js" as="script" /><link rel="prefetch" href="/assets/03.任务优先级与事件优先级.html.916276aa.js" as="script" /><link rel="prefetch" href="/assets/04.lane模型下的更新队列.html.4503c8f0.js" as="script" /><link rel="prefetch" href="/assets/05.加入优先级的初始化渲染.html.35477d9f.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.6ade355f.js" as="script" /><link rel="prefetch" href="/assets/02.同步渲染.html.d66e5460.js" as="script" /><link rel="prefetch" href="/assets/03.并发渲染.html.1ecfc0a1.js" as="script" /><link rel="prefetch" href="/assets/04.思考题.html.6a500a41.js" as="script" /><link rel="prefetch" href="/assets/404.html.8e2a22ff.js" as="script" /><link rel="prefetch" href="/assets/giscus.06b5451c.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/developer.jpeg" alt="杨艺韬讲堂"><span class="site-name can-hide">杨艺韬讲堂</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/react18/" class="" aria-label="手写React源码"><!--[--><!--]--> 手写React源码 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue3/" class="" aria-label="Vue3源码剖析"><!--[--><!--]--> Vue3源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/microfe/" class="router-link-active" aria-label="微前端源码剖析"><!--[--><!--]--> 微前端源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://www.github.com/yangyitao100" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/react18/" class="" aria-label="手写React源码"><!--[--><!--]--> 手写React源码 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue3/" class="" aria-label="Vue3源码剖析"><!--[--><!--]--> Vue3源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/microfe/" class="router-link-active" aria-label="微前端源码剖析"><!--[--><!--]--> 微前端源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://www.github.com/yangyitao100" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/microfe/README.md" class="sidebar-item sidebar-heading active" aria-label="微前端源码剖析"><!--[--><!--]--> 微前端源码剖析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a href="/microfe/01.%E4%B9%BE%E5%9D%A4%E7%9A%84Js%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%EF%BC%88%E5%BF%AB%E7%85%A7%E6%B2%99%E7%AE%B1%E3%80%81%E4%B8%A4%E7%A7%8D%E4%BB%A3%E7%90%86%E6%B2%99%E7%AE%B1%EF%BC%89.html" class="sidebar-item" aria-label="01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱）"><!--[--><!--]--> 01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱） <!--[--><!--]--></a><!----></li><li><a href="/microfe/02.%E4%B9%BE%E5%9D%A4%E7%9A%84%E5%BE%AE%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90(%E4%BB%8E%E5%BE%AE%E5%BA%94%E7%94%A8%E7%9A%84%E6%B3%A8%E5%86%8C%E5%88%B0loadApp%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0).html" class="sidebar-item" aria-label="02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现)"><!--[--><!--]--> 02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/microfe/03.%E4%B9%BE%E5%9D%A4%E7%9A%84%E6%B2%99%E7%AE%B1%E5%AE%B9%E5%99%A8%E5%88%86%E6%9E%90%EF%BC%88Js%E6%B2%99%E7%AE%B1%E6%9C%BA%E5%88%B6%E5%BB%BA%E7%AB%8B%E5%90%8E%E7%9A%84%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%EF%BC%89.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）"><!--[--><!--]--> 03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用） <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/microfe/03.%E4%B9%BE%E5%9D%A4%E7%9A%84%E6%B2%99%E7%AE%B1%E5%AE%B9%E5%99%A8%E5%88%86%E6%9E%90%EF%BC%88Js%E6%B2%99%E7%AE%B1%E6%9C%BA%E5%88%B6%E5%BB%BA%E7%AB%8B%E5%90%8E%E7%9A%84%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%EF%BC%89.html#函数patchstrictsandbox的第一部分逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="函数patchStrictSandbox的第一部分逻辑"><!--[--><!--]--> 函数patchStrictSandbox的第一部分逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/microfe/03.%E4%B9%BE%E5%9D%A4%E7%9A%84%E6%B2%99%E7%AE%B1%E5%AE%B9%E5%99%A8%E5%88%86%E6%9E%90%EF%BC%88Js%E6%B2%99%E7%AE%B1%E6%9C%BA%E5%88%B6%E5%BB%BA%E7%AB%8B%E5%90%8E%E7%9A%84%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%EF%BC%89.html#函数patchstrictsandbox的第二部分逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="函数patchStrictSandbox的第二部分逻辑"><!--[--><!--]--> 函数patchStrictSandbox的第二部分逻辑 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/microfe/04.%E4%B9%BE%E5%9D%A4%E7%9A%84%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6(import-html-entry%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0).html" class="sidebar-item" aria-label="04.乾坤的资源加载机制(import-html-entry的内部实现)"><!--[--><!--]--> 04.乾坤的资源加载机制(import-html-entry的内部实现) <!--[--><!--]--></a><!----></li><li><a href="/microfe/05.%E4%B9%BE%E5%9D%A4loadMicroApp%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90.html" class="sidebar-item" aria-label="05.乾坤loadMicroApp方法实现以及数据通信机制分析"><!--[--><!--]--> 05.乾坤loadMicroApp方法实现以及数据通信机制分析 <!--[--><!--]--></a><!----></li><li><a href="/microfe/06.single-spa%E7%9A%84%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6.html" class="sidebar-item" aria-label="06.single-spa的注册机制"><!--[--><!--]--> 06.single-spa的注册机制 <!--[--><!--]--></a><!----></li><li><a href="/microfe/07.%E5%AF%B9single-spa%E7%9A%84%E8%B7%AF%E7%94%B1%E7%AE%A1%E7%90%86%E5%8F%8A%E5%BE%AE%E5%BA%94%E7%94%A8%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E7%9A%84%E5%88%86%E6%9E%90.html" class="sidebar-item" aria-label="07.对single-spa的路由管理及微应用状态管理的分析"><!--[--><!--]--> 07.对single-spa的路由管理及微应用状态管理的分析 <!--[--><!--]--></a><!----></li><li><a href="/microfe/08.single-spa%E4%B8%AD%E7%9A%84reroute%E5%87%BD%E6%95%B0.html" class="sidebar-item" aria-label="08.single-spa中的reroute函数"><!--[--><!--]--> 08.single-spa中的reroute函数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="_03-乾坤的沙箱容器分析-js沙箱机制建立后的具体应用" tabindex="-1"><a class="header-anchor" href="#_03-乾坤的沙箱容器分析-js沙箱机制建立后的具体应用" aria-hidden="true">#</a> 03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）</h1><blockquote><p>在 <strong>乾坤的Js隔离机制（快照沙箱、两种代理沙箱）</strong> 一文中，我们知道了乾坤的沙箱的核心原理和具体实现。但知道这些还不够，因为沙箱本身就像是一个工具，有了工具还得应用到实践中，这个工具才能创造价值发挥作用。我们也在<a href="/microfe/02.%E4%B9%BE%E5%9D%A4%E7%9A%84%E5%BE%AE%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90(%E4%BB%8E%E5%BE%AE%E5%BA%94%E7%94%A8%E7%9A%84%E6%B3%A8%E5%86%8C%E5%88%B0loadApp%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0).html" class="">微前端02 : 乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现)</a>中提到了在加载微应用过程中跟沙箱相关的部分逻辑，但受限于篇幅并未展开。本文将会详细讲解乾坤对沙箱的具体应用。</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token doc-comment comment">/******************************************************************/</span>
<span class="token doc-comment comment">/*****************     欢迎关注微信公众号：杨艺韬     *****************/</span>
<span class="token doc-comment comment">/******************************************************************/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="沙箱容器的主逻辑" tabindex="-1"><a class="header-anchor" href="#沙箱容器的主逻辑" aria-hidden="true">#</a> 沙箱容器的主逻辑</h1><p>对沙箱机制的具体应用，本质上就是对<strong>沙箱容器</strong>的控制，至于什么是<strong>沙箱容器</strong>，我们直接看代码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段一，所属文件：src/sandbox/index.ts</span>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@param</span> <span class="token parameter">appName</span>
 * <span class="token keyword">@param</span> <span class="token parameter">elementGetter</span>
 * <span class="token keyword">@param</span> <span class="token parameter">scopedCSS</span>
 * <span class="token keyword">@param</span> <span class="token parameter">useLooseSandbox</span>
 * <span class="token keyword">@param</span> <span class="token parameter">excludeAssetFilter</span>
 * <span class="token keyword">@param</span> <span class="token parameter">globalContext</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
  <span class="token literal-property property">appName</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">elementGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">scopedCSS</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  useLooseSandbox<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">url</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">,</span>
  globalContext<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">typeof</span> window<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> SandBox<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sandbox <span class="token operator">=</span> useLooseSandbox <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LegacySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> globalContext<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ProxySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> globalContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    sandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnapshotSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 此处省略许多代码...   占位1</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">instance</span><span class="token operator">:</span> sandbox<span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处省略许多代码... 占位2</span>
      sandbox<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 此处省略许多代码... 占位3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处省略许多代码... 占位4</span>
      sandbox<span class="token punctuation">.</span><span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 此处省略许多代码... 占位5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由代码片段一可知，所谓<strong>沙箱容器</strong>，就是一个对象。该对象包括三个属性<code>instance、mount、unmount</code>，其中<code>instace</code>代表沙箱实例，<code>mount、unmount</code>是两个方法，供<strong>沙箱容器</strong>持有者在合适的时机进行调用。关于沙箱实例，我们先看创建沙箱实例的时候传入了<code>globalContext</code>，还记得我们在<a href="/microfe/01.%E4%B9%BE%E5%9D%A4%E7%9A%84Js%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%EF%BC%88%E5%BF%AB%E7%85%A7%E6%B2%99%E7%AE%B1%E3%80%81%E4%B8%A4%E7%A7%8D%E4%BB%A3%E7%90%86%E6%B2%99%E7%AE%B1%EF%BC%89.html" class="">微前端01 : 乾坤的Js隔离机制（快照沙箱、两种代理沙箱）</a>中各沙箱的极简版吧，当时我直接用的<code>window</code>，那为什么在真实源码中要通过传入<code>globalContext</code>而不是直接使用<code>window</code>呢。答案其实很简单，参数存在的意义就是参数值可变，否则都直接写死了，换句话说更灵活了。举个例子，如果我们的微应用的载体是另一个微应用呢？如果没有这种灵活性，就不能很好的支持复杂多变的场景，乾坤作为业界知名框架，在众多开发者的打磨下，对于细节的处理确实很值得学习。聊完了沙箱实例的创建，我们再来看看<code>mount、unmount</code>这两个方法。如果忽略省略的代码片段注释处省略的代码，那<code>mount、unmount</code>仅仅是调用<code>sandbox.active</code>、<code>sandbox.inactive</code>两个方法让沙箱激活或者失活。如果是这样的话，这个沙箱容器的存在的意义就不大了，但我在介绍<code>mount、unmount</code>两个方法中的其他逻辑之前，我们来先看看代码片段一中<strong>占位1</strong>处的三行代码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段二，所属文件：src/sandbox/index.ts</span>
<span class="token keyword">const</span> bootstrappingFreers <span class="token operator">=</span> <span class="token function">patchAtBootstrapping</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">mountingFreers</span><span class="token operator">:</span> Freer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> <span class="token literal-property property">sideEffectsRebuilders</span><span class="token operator">:</span> Rebuilder<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="函数patchatbootstrapping" tabindex="-1"><a class="header-anchor" href="#函数patchatbootstrapping" aria-hidden="true">#</a> 函数patchAtBootstrapping</h1><p>我们先暂时只关注第一行代码，这里调用了函数<code>patchAtBootstrapping</code>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段三，所属文件：src/sandbox/patchers/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchAtBootstrapping</span><span class="token punctuation">(</span>
  <span class="token literal-property property">appName</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">elementGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">sandbox</span><span class="token operator">:</span> SandBox<span class="token punctuation">,</span>
  <span class="token literal-property property">scopedCSS</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> CallableFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Freer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> patchersInSandbox <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>SandBoxType<span class="token punctuation">.</span>LegacyProxy<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">patchLooseSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SandBoxType<span class="token punctuation">.</span>Proxy<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">patchStrictSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SandBoxType<span class="token punctuation">.</span>Snapshot<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">patchLooseSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> patchersInSandbox<span class="token punctuation">[</span>sandbox<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">patch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数<code>patchAtBootstrapping</code>只做了一件事情，就是根据不同的沙箱类型，执行后并以数组的形式返回执行结果。为什么是数组类型呢？就这个方法本身而言，直接返回函数值没有任何问题，因为从代码中可以看出，不管何种沙箱类型，在<code>patchAtBootstrapping</code>中，都只执行了一个函数。之所以包装成数组，是因为其他和<code>patchAtBootstrapping</code>发挥作用类似的函数，比如<code>patchAtMounting</code>,里面就会有多个函数需要执行。这样做的好处是，保证了数据格式的统一，利于后续相关逻辑进行统一处理，同时也有很好的可扩展性，将来如果函数<code>patchAtBootstrapping</code>需要执行多个函数，不需要改动代码整体结构。这是我们值得学习的。</p><h1 id="函数patchstrictsandbox" tabindex="-1"><a class="header-anchor" href="#函数patchstrictsandbox" aria-hidden="true">#</a> 函数patchStrictSandbox</h1><p>至于<code>patchLooseSandbox、patchStrictSandbox、patchLooseSandbox</code>这三个函数。接下来我只深入到<code>patchStrictSandbox</code>中去，因为<code>patchStrictSandbox</code>最重要，其他两个函数的内部主体逻辑和<code>patchStrictSandbox</code>类似，感兴趣的朋友们可以自行阅读，如果有不清楚的地方可以留言交流。接下来我们就看看函数<code>patchStrictSandbox</code>的代码吧：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段四，所属文件：src/sandbox/patchers/dynamicAppend/forStrictSandbox.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchStrictSandbox</span><span class="token punctuation">(</span>
  <span class="token literal-property property">appName</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">appWrapperGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">proxy</span><span class="token operator">:</span> Window<span class="token punctuation">,</span>
  mounting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  scopedCSS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> CallableFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Freer <span class="token punctuation">{</span>
  <span class="token comment">// 此处省略许多代码... 占位1</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此处省略许多代码... 占位2</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 此处省略许多代码... 占位3</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在省略了许多代码后，我们可以直观的看到该函数的主体结构，这个过程我们可以用伪代码来描述这个调用过程：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段五</span>
<span class="token keyword">let</span> freeFunc <span class="token operator">=</span> <span class="token function">patchStrictSandbox</span><span class="token punctuation">(</span>许多参数<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一步：在这个函数里面执行了代码，影响了程序状态</span>
<span class="token keyword">let</span> rebuidFun <span class="token operator">=</span> <span class="token function">freeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二步：将第一步中对程序状态的影响撤销掉</span>
<span class="token function">rebuidFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第三步：恢复到第一步执行完成时程序的状态</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>理解了<code>patchStrictSandbox</code>的主逻辑，我们来看看代码片段四中<strong>占位1</strong>处所省略的代码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段六，所属文件：src/sandbox/patchers/dynamicAppend/forStrictSandbox.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchStrictSandbox</span><span class="token punctuation">(</span>
  <span class="token literal-property property">appName</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">appWrapperGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">proxy</span><span class="token operator">:</span> Window<span class="token punctuation">,</span>
  mounting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  scopedCSS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> CallableFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Freer <span class="token punctuation">{</span>
    <span class="token comment">//*********************第一部分*********************/</span>
    <span class="token keyword">let</span> containerConfig <span class="token operator">=</span> proxyAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        containerConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
          appName<span class="token punctuation">,</span>
          proxy<span class="token punctuation">,</span>
          appWrapperGetter<span class="token punctuation">,</span>
          <span class="token literal-property property">dynamicStyleSheetElements</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">strictGlobal</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          excludeAssetFilter<span class="token punctuation">,</span>
          scopedCSS<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        proxyAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> containerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dynamicStyleSheetElements <span class="token punctuation">}</span> <span class="token operator">=</span> containerConfig<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/***********************第二部分*********************/</span>
    <span class="token keyword">const</span> unpatchDocumentCreate <span class="token operator">=</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> unpatchDynamicAppendPrototypeFunctions <span class="token operator">=</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 此处省略许多代码... </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="函数patchstrictsandbox的第一部分逻辑" tabindex="-1"><a class="header-anchor" href="#函数patchstrictsandbox的第一部分逻辑" aria-hidden="true">#</a> 函数patchStrictSandbox的第一部分逻辑</h2><p>我们先来分析代码片段六中的第一部分，可以看到该部分有几个重要的变量，<code>proxyAttachContainerConfigMap、dynamicStyleSheetElements、proxy、containerConfig</code>，这部分代码做了三件事，<strong>一</strong>是从缓存变量<code>proxyAttachContainerConfigMap</code>中根据<code>proxy</code>获取配置对象，如果有就赋值给变量<code>containerConfig</code>。<strong>二</strong>是如果缓存中没有<code>proxy</code>对应的配置对象，那么则定一个初始化配置对象，并以<code>proxy</code>为<code>key</code>，以这个配置对象为<code>value</code>，存储到缓存变量<code>proxyAttachContainerConfigMap</code>中。<strong>三</strong>是从<code>containerConfig</code>中获取<code>dynamicStyleSheetElements</code>。这里有几个点值得推敲。 首先，<code>proxy</code>是什么，为什么要以<code>proxy</code>为<code>key</code>将配置对象存储在<code>proxyAttachContainerConfigMap</code>中？<code>proxy</code>实际上就是在上文代码片段一中创建的沙箱实例，对应代码片段一中的<code>sandbox</code>变量。</p><p>其次，在代码片段六中，<code>proxyAttachContainerConfigMap</code>只赋值了初始值，既然有是从缓存变量<code>proxyAttachContainerConfigMap</code>中根据<code>proxy</code>获取配置对象的这个操作，说明<code>proxyAttachContainerConfigMap</code>肯定在其他地方有更新<code>containerConfig</code>的操作，否则没必要只缓存一个初始化值。具体应该在哪里更新这个<code>containerConfig</code>，更新<code>containerConfig</code>中的哪个属性对应的值，我们在后文会提到。</p><p>最后，<code>dynamicStyleSheetElements</code>是什么？实际上其类型是<code>HTMLStyleElement[]</code>，<code>HTMLStyleElement</code>表示<code>&lt;style&gt;</code>元素。我们这里不追究<code>HTMLStyleElement</code>到底有多少属性和方法，但需要关注的是，<code>HTMLStyleElement</code>实例中有一个<code>sheet</code>属性，这个属性是一个<code>CSSStyleSheet</code>对象。至于<code>CSSStyleSheet</code>的概念和各种属性我就不在这里一一详述了，可以参阅相关<a href="https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>了解。此时我们需要知道的是，<code>CSSStyleSheet</code>的实例有个重要的属性<code>cssRules</code>，该属性类型为<code>CSSRuleList</code>，是一个<code>CSSStyleRule</code>对象数组。关于<code>CSSStyleRule</code>的详细内容就不继续介绍了，只需要知道<code>CSSStyleRule</code>相当于代表了一条具体的css样式，如下所示：</p><div class="language-css line-numbers-mode" data-ext="css"><pre class="language-css"><code><span class="token selector">// 注意虽然样式呈现的效果等价，但实际上通过CssStyleRule控制样式和普通的以文本的形式挂载到dom上的样式有着一些不同，这些不同会在后面提到
div</span><span class="token punctuation">{</span>
   <span class="token property">color</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里了解这些就足够了，后续在分析乾坤对css资源进行处理的时候还会涉及<code>CSSStyleRule</code>，到时再继续探讨。</p><blockquote><p>注：请阅读英文版MDN文档，对于HTMLStyleElement的解释，中文版的 翻译还比较落后，与<a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLStyleElement" target="_blank" rel="noopener noreferrer">英文版<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>的介绍有出入</p></blockquote><h2 id="函数patchstrictsandbox的第二部分逻辑" tabindex="-1"><a class="header-anchor" href="#函数patchstrictsandbox的第二部分逻辑" aria-hidden="true">#</a> 函数patchStrictSandbox的第二部分逻辑</h2><p>这时我们将视野回到代码片段六中的第二部分，为了方便阅读将相关代码放到这里：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> unpatchDocumentCreate <span class="token operator">=</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> unpatchDynamicAppendPrototypeFunctions <span class="token operator">=</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="patchdocumentcreateelement" tabindex="-1"><a class="header-anchor" href="#patchdocumentcreateelement" aria-hidden="true">#</a> patchDocumentCreateElement</h1><p>我们先看看<code>patchDocumentCreateElement</code>中的代码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 代码片段七，所属文件：src/sandbox/patchers/dynamicAppend/forStrictSandbox.ts</span>
<span class="token keyword">function</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略许多代码...</span>
    <span class="token keyword">const</span> rawDocumentCreateElement <span class="token operator">=</span> document<span class="token punctuation">.</span>createElement<span class="token punctuation">;</span>
    <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> createElement（
        <span class="token comment">// 省略许多代码...</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">rawDocumentCreateElement</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 关键点1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHijackingTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略许多代码</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 关键点2 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&#39;createElement&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>createElement <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 关键点3 </span>
    docCreatePatchedMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement<span class="token punctuation">,</span> rawDocumentCreateElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unpatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 关键点4</span>
    <span class="token comment">//此次省略一些代码...</span>
    <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement <span class="token operator">=</span> docCreateElementFnBeforeOverwrite<span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>createElement <span class="token operator">=</span> docCreateElementFnBeforeOverwrite<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在省略一些代码后，<code>patchDocumentCreateElement</code>函数实现的功能，逐渐清晰可见。该函数主要做了三件事情。<strong>一</strong>是重写<code>Document.prototype.createElement</code>，重写的目的在代码片段七中的关键点<strong>1</strong>体现，具体关键点<strong>1</strong>内部做了什么由于逻辑较简单暂不在这里介绍。<strong>二</strong>是保存重写后的<code>createElement</code>和重写前的<code>createElement</code>这二者的对应关系，对应关键点<strong>3</strong>。至于上面代码片段提到的关键点<strong>2</strong>，是对<code>document</code>的一个变化，这个点应该和其他地方的逻辑有关系，否则没有必要对<code>document</code>进行判断处理，暂时没发现用到这个处理的地方，后续找到了相关逻辑再补上这个细节，但意义不太大，再看情况决定。<strong>三</strong>是返回一个函数，该函数会还原重写<code>Document.prototype.createElement</code>时候对<code>Document.prototype.createElement</code>的影响。</p><p>由于篇幅较长，请将我们的视野再次移动到代码片段六中的第二部分：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> unpatchDocumentCreate <span class="token operator">=</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> unpatchDynamicAppendPrototypeFunctions <span class="token operator">=</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>刚才我们分析了函数<code>patchDocumentCreateElement</code>，现在可以知道代码片段中的<code>unpatchDocumentCreate</code>是一个函数，执行后会清除对<code>Document.prototype.createElement</code>的影响。这里我不再进入函数<code>patchHTMLDynamicAppendPrototypeFunctions</code>中进行分析，原理和函数<code>patchDocumentCreateElement</code>类似，只不过其影响和恢复的的是 <code>HTMLHeadElement.prototype.appendChild、HTMLHeadElement.prototype.removeChild、HTMLBodyElement.prototype.removeChild、HTMLHeadElement.prototype.insertBefore</code>等原型方法。</p><h1 id="函数patchstrictsandbox的free函数" tabindex="-1"><a class="header-anchor" href="#函数patchstrictsandbox的free函数" aria-hidden="true">#</a> 函数patchStrictSandbox的free函数</h1><p>此时，请将视线移动到代码片段四中的<strong>占位2</strong>处，代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 此处省略许多代码...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>allMicroAppUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">unpatchDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">unpatchDocumentCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">recordStyledComponentsCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上文的分析我们知道，执行<code>unpatchDynamicAppendPrototypeFunctions、unpatchDocumentCreate</code>两个函数后，会清除重写相应原型函数的影响。我们重点看看<code>recordStyledComponentsCSSRules(dynamicStyleSheetElements);</code>，代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">recordStyledComponentsCSSRules</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">styleElements</span><span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  styleElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">styleElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>styleElement <span class="token keyword">instanceof</span> <span class="token class-name">HTMLStyleElement</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isStyledComponentsLike</span><span class="token punctuation">(</span>styleElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>styleElement<span class="token punctuation">.</span>sheet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        styledComponentCSSRulesMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>styleElement<span class="token punctuation">,</span> <span class="token punctuation">(</span>styleElement<span class="token punctuation">.</span>sheet <span class="token keyword">as</span> CSSStyleSheet<span class="token punctuation">)</span><span class="token punctuation">.</span>cssRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>核心其实只有一行代码：<code>styledComponentCSSRulesMap.set(styleElement, (styleElement.sheet as CSSStyleSheet).cssRules);</code>。上文我们知道了<code>cssRules</code>代表着一条条具体的css样式，就这行代码而言，这些样式是从远程加载而来，相当于从网络上获取了一个<code>css</code>文件，然后对其中的内容进行解析，生成一个<code>style</code>标签，<code>style</code>标签具体承载的样式并非以字符串的形式，这里的具体代码比较冗长暂时不贴出来。实际上就是保存一个<code>style</code>标签对象和其中的内容之间的关系。这里保存的<code>cssRules</code>在下文的分析中会用到。</p><h1 id="函数patchstrictsandbox中free函数的rebuild函数" tabindex="-1"><a class="header-anchor" href="#函数patchstrictsandbox中free函数的rebuild函数" aria-hidden="true">#</a> 函数patchStrictSandbox中free函数的rebuild函数</h1><p>此时，请将视线移动到代码片段四中的<strong>占位3</strong>处，代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">rebuildCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stylesheetElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> appWrapper <span class="token operator">=</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>appWrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rawHeadAppendChild</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appWrapper<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的rebuildCSSRules函数如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rebuildCSSRules</span><span class="token punctuation">(</span>
  <span class="token literal-property property">styleSheetElements</span><span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">reAppendElement</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">stylesheetElement</span><span class="token operator">:</span> HTMLStyleElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  styleSheetElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">stylesheetElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> appendSuccess <span class="token operator">=</span> <span class="token function">reAppendElement</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appendSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stylesheetElement <span class="token keyword">instanceof</span> <span class="token class-name">HTMLStyleElement</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isStyledComponentsLike</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> cssRules <span class="token operator">=</span> <span class="token function">getStyledElementCSSRules</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cssRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cssRules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cssRule <span class="token operator">=</span> cssRules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> cssStyleSheetElement <span class="token operator">=</span> stylesheetElement<span class="token punctuation">.</span>sheet <span class="token keyword">as</span> CSSStyleSheet<span class="token punctuation">;</span>
            cssStyleSheetElement<span class="token punctuation">.</span><span class="token function">insertRule</span><span class="token punctuation">(</span>cssRule<span class="token punctuation">.</span>cssText<span class="token punctuation">,</span> cssStyleSheetElement<span class="token punctuation">.</span>cssRules<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从代码逻辑看可以直观的看出两件事情，<strong>一</strong>是将前面生成的<code>style</code>标签添加到微应用上；<strong>二</strong>是将之前保存的<code>cssRule</code>插入到对应的<code>style</code>标签上。为什么一定要执行<code>insertRule</code>呢?通过<code>cssRule</code>动态控制样式和普通<code>style</code>标签控制样式有所不同。一旦<code>cssRule</code>所关联的<code>style</code>标签脱离<code>document</code>，这些<code>cssRule</code>都会失效。这也是为什么需要保存和重新设置的原因。</p><p>到此，本文代码片段一中的<strong>占位1</strong>处的代码就算执行完成了。对<strong>占位1</strong>的代码理解清楚后，本文也就基本完成了。因为<code>mount、unmount</code>其实就是在利用<strong>占位1</strong>提供的<code>bootstrappingFreers</code>函数改变以及恢复状态。</p><p>欢迎关注我的<code>微信订阅号：杨艺韬</code>，可以获取最新动态。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yangyitao2@tal.com">yangyitao</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/microfe/02.%E4%B9%BE%E5%9D%A4%E7%9A%84%E5%BE%AE%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90(%E4%BB%8E%E5%BE%AE%E5%BA%94%E7%94%A8%E7%9A%84%E6%B3%A8%E5%86%8C%E5%88%B0loadApp%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0).html" class="" aria-label="02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现)"><!--[--><!--]--> 02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现) <!--[--><!--]--></a></span><span class="next"><a href="/microfe/04.%E4%B9%BE%E5%9D%A4%E7%9A%84%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6(import-html-entry%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0).html" class="" aria-label="04.乾坤的资源加载机制(import-html-entry的内部实现)"><!--[--><!--]--> 04.乾坤的资源加载机制(import-html-entry的内部实现) <!--[--><!--]--></a></span></p></nav><!--[--><!--[--><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!-- <div style="width: 100%; text-align:center; margin-top: 60px; position: absolute; background: red">
        <a style="color:#a7a7a7; font-size:14px;" href="https://beian.miit.gov.cn">蜀ICP备2023033985号-3 &copy; 玄工科技（四川）有限责任公司</a>
      </div> --><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.c996eb5c.js" defer></script>
  </body>
</html>
