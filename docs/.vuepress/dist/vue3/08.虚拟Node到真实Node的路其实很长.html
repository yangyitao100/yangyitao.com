<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.53">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?3ada78bd736d6c32ac7d2e900e4e3d9d";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();</script><link rel="icon" href="/images/developer.jpeg"><title>08.虚拟Node到真实Node的路其实很长 | 杨艺韬讲堂</title><meta name="description" content="杨艺韬讲堂, 杨艺韬, Adam Yang, react18, React, vue3, 源码, 前端">
    <link rel="preload" href="/assets/style.512c328e.css" as="style" /><link rel="stylesheet" href="/assets/style.512c328e.css" />
    <link rel="modulepreload" href="/assets/app.03bf752b.js"><link rel="modulepreload" href="/assets/08.虚拟Node到真实Node的路其实很长.html.c5107228.js"><link rel="modulepreload" href="/assets/08.虚拟Node到真实Node的路其实很长.html.34502cd7.js"><link rel="prefetch" href="/assets/index.html.bc8c8d70.js" as="script" /><link rel="prefetch" href="/assets/README_en.html.284d9689.js" as="script" /><link rel="prefetch" href="/assets/index.html.bba26bdf.js" as="script" /><link rel="prefetch" href="/assets/01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱）.html.58370679.js" as="script" /><link rel="prefetch" href="/assets/02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现).html.0d8c0575.js" as="script" /><link rel="prefetch" href="/assets/03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）.html.3d13d503.js" as="script" /><link rel="prefetch" href="/assets/04.乾坤的资源加载机制(import-html-entry的内部实现).html.92a85075.js" as="script" /><link rel="prefetch" href="/assets/05.乾坤loadMicroApp方法实现以及数据通信机制分析.html.e159d950.js" as="script" /><link rel="prefetch" href="/assets/06.single-spa的注册机制.html.1e86d052.js" as="script" /><link rel="prefetch" href="/assets/07.对single-spa的路由管理及微应用状态管理的分析.html.850dc54e.js" as="script" /><link rel="prefetch" href="/assets/08.single-spa中的reroute函数.html.dc26bab2.js" as="script" /><link rel="prefetch" href="/assets/index.html.68f323cd.js" as="script" /><link rel="prefetch" href="/assets/index.html.5b38e8b9.js" as="script" /><link rel="prefetch" href="/assets/01.代码管理策略-monorepo.html.d2d577b6.js" as="script" /><link rel="prefetch" href="/assets/02.项目构建流程和源码调试方法.html.33eb6ed9.js" as="script" /><link rel="prefetch" href="/assets/03.Vue3响应式核心原理.html.1cd6ecba.js" as="script" /><link rel="prefetch" href="/assets/04.Vue3响应式系统源码实现1.html.90173631.js" as="script" /><link rel="prefetch" href="/assets/05.Vue3响应式系统源码实现2.html.c18f024a.js" as="script" /><link rel="prefetch" href="/assets/06.reactive、ref相关api源码实现.html.f1ada482.js" as="script" /><link rel="prefetch" href="/assets/07.故事要从createApp讲起.html.6dae10d0.js" as="script" /><link rel="prefetch" href="/assets/09.组件渲染和更新流程.html.e67daf6b.js" as="script" /><link rel="prefetch" href="/assets/10.名动江湖的diff算法.html.844ae1a8.js" as="script" /><link rel="prefetch" href="/assets/11.编译优化之Block Tree 与 PatchFlags.html.5736a5a6.js" as="script" /><link rel="prefetch" href="/assets/12.编译过程介绍及分析模版AST的生成过程.html.5647b4a3.js" as="script" /><link rel="prefetch" href="/assets/13.从AST到render函数（transform与代码生成）.html.e51e34f5.js" as="script" /><link rel="prefetch" href="/assets/index.html.e7f880cd.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.83c991ec.js" as="script" /><link rel="prefetch" href="/assets/02.树立正确的源码观.html.fb13da14.js" as="script" /><link rel="prefetch" href="/assets/03.React是什么.html.8ab59fb0.js" as="script" /><link rel="prefetch" href="/assets/04.React架构演进过程.html.393e1a6f.js" as="script" /><link rel="prefetch" href="/assets/05.树立数据结构与算法的意识.html.ca13f42a.js" as="script" /><link rel="prefetch" href="/assets/06.树立用原子视角看问题的意识.html.d0de50fb.js" as="script" /><link rel="prefetch" href="/assets/07.React18源码学习方法.html.4c3ab811.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.22395461.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.21cf1d16.js" as="script" /><link rel="prefetch" href="/assets/03.虚拟DOM与真实DOM的实况对比.html.559bb4a0.js" as="script" /><link rel="prefetch" href="/assets/04.JSX相关概念和原理.html.06fcc809.js" as="script" /><link rel="prefetch" href="/assets/05.React和ReactDOM职责划分.html.33c9e328.js" as="script" /><link rel="prefetch" href="/assets/06.createElement代码实现.html.0456a944.js" as="script" /><link rel="prefetch" href="/assets/07.实现 render、mount 和 createDOM进行初次渲染.html.41543d69.js" as="script" /><link rel="prefetch" href="/assets/08.实现函数setPropsForDOM为DOM设置属性.html.37d884ac.js" as="script" /><link rel="prefetch" href="/assets/09.调试初始化渲染过程.html.e76fd42c.js" as="script" /><link rel="prefetch" href="/assets/10.思考题与解答.html.6ed61faa.js" as="script" /><link rel="prefetch" href="/assets/11.本章小结.html.f91c6139.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.b5f266a9.js" as="script" /><link rel="prefetch" href="/assets/02.函数组件与类组件介绍.html.2c4a5a13.js" as="script" /><link rel="prefetch" href="/assets/03.实现函数组件基础功能.html.b9da3afc.js" as="script" /><link rel="prefetch" href="/assets/04.实现类组件基础功能.html.69a246c3.js" as="script" /><link rel="prefetch" href="/assets/05.类组件的更新机制分析.html.19428106.js" as="script" /><link rel="prefetch" href="/assets/06.实现类组件的setState方法.html.8e46262c.js" as="script" /><link rel="prefetch" href="/assets/07.事件合成机制原理分析.html.830bf124.js" as="script" /><link rel="prefetch" href="/assets/08.事件合成机制的简单实现.html.37ae6cb4.js" as="script" /><link rel="prefetch" href="/assets/09.ref的原理分析.html.64825db1.js" as="script" /><link rel="prefetch" href="/assets/10.类组件的ref源码实现.html.2d266ccd.js" as="script" /><link rel="prefetch" href="/assets/11.引入forwardRef的底层逻辑.html.80288dc9.js" as="script" /><link rel="prefetch" href="/assets/12.实现forwardRef为函数组件提供ref的能力.html.7b832146.js" as="script" /><link rel="prefetch" href="/assets/13.调试函数组件与类组件相关代码.html.c5318fc6.js" as="script" /><link rel="prefetch" href="/assets/14.思考题与解答.html.e29d1ced.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.0a37d66d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.5c56ed55.js" as="script" /><link rel="prefetch" href="/assets/02.React DOM DIFF原理.html.c06333b9.js" as="script" /><link rel="prefetch" href="/assets/03.React DOM DIFF算法源码实现.html.a92af391.js" as="script" /><link rel="prefetch" href="/assets/04.调试DOM DIFF算法.html.a39f906a.js" as="script" /><link rel="prefetch" href="/assets/05.思考题及解答.html.a964dca8.js" as="script" /><link rel="prefetch" href="/assets/06.本章小结.html.9f3b6ec7.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.0109b860.js" as="script" /><link rel="prefetch" href="/assets/02.生命周期的内涵.html.fede1a71.js" as="script" /><link rel="prefetch" href="/assets/03.生命周期图观察.html.974682b4.js" as="script" /><link rel="prefetch" href="/assets/04.常用生命周期函数应用案例.html.58f4fa8d.js" as="script" /><link rel="prefetch" href="/assets/05.常用生命周期函数源码实现.html.f2204171.js" as="script" /><link rel="prefetch" href="/assets/06.shouldComponentUpdate案例.html.dcef12d5.js" as="script" /><link rel="prefetch" href="/assets/07.shouldComponentUpdate实现.html.3755b6c4.js" as="script" /><link rel="prefetch" href="/assets/08.getDeriveStateFromProp案例.html.8a1252bb.js" as="script" /><link rel="prefetch" href="/assets/09.getDeriveStateFromProps源码实现.html.9db4f077.js" as="script" /><link rel="prefetch" href="/assets/10.getSnapshotBeforeUpdate应用案例.html.071a1bd9.js" as="script" /><link rel="prefetch" href="/assets/11.getSnapshotBeforeUpdate源码实现.html.cfa8ce6c.js" as="script" /><link rel="prefetch" href="/assets/12.生命周期相关代码调试.html.17603927.js" as="script" /><link rel="prefetch" href="/assets/13.思考题及解答.html.a7f21ab0.js" as="script" /><link rel="prefetch" href="/assets/14.本章小结.html.bcba6af3.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.ad1b676f.js" as="script" /><link rel="prefetch" href="/assets/02.PureComponent应用案例.html.29c8f991.js" as="script" /><link rel="prefetch" href="/assets/03.PureComponent源码实现.html.74ae40b9.js" as="script" /><link rel="prefetch" href="/assets/04.memo应用案例.html.3ef4e9fe.js" as="script" /><link rel="prefetch" href="/assets/05.memo源码实现.html.9486e679.js" as="script" /><link rel="prefetch" href="/assets/06.调试PureComponent及memo相关的代码.html.b627d26b.js" as="script" /><link rel="prefetch" href="/assets/07.思考题及解答.html.30aff959.js" as="script" /><link rel="prefetch" href="/assets/08.本章小结.html.ed797777.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.93f955bf.js" as="script" /><link rel="prefetch" href="/assets/02.Hooks存在的意义.html.99f853db.js" as="script" /><link rel="prefetch" href="/assets/03.useState应用案例.html.7a27c44c.js" as="script" /><link rel="prefetch" href="/assets/04.useState源码实现.html.b6770829.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer应用案例.html.18c8d25e.js" as="script" /><link rel="prefetch" href="/assets/06.useReducer源码实现.html.e02afb3e.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect及useLayoutEffect应用案例.html.6d954f40.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect及useLayoutEffect源码实现.html.c7da98a1.js" as="script" /><link rel="prefetch" href="/assets/09.useRef应用案例及源码实现.html.83fab4fd.js" as="script" /><link rel="prefetch" href="/assets/10.useImperativeHandle应用案例及源码实现.html.b6a790ea.js" as="script" /><link rel="prefetch" href="/assets/11.useMemo及useCallback应用案例.html.01058c5f.js" as="script" /><link rel="prefetch" href="/assets/12.useMemo及useCallback源码实现.html.6fdcbe57.js" as="script" /><link rel="prefetch" href="/assets/13.Hooks相关源码调试.html.87195cff.js" as="script" /><link rel="prefetch" href="/assets/14.思考题及解答.html.1bd5bf45.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.d89b82e8.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.d46d0437.js" as="script" /><link rel="prefetch" href="/assets/02.为什么需要Fiber架构.html.d180591d.js" as="script" /><link rel="prefetch" href="/assets/03.Fiber架构是什么.html.54fe6f6c.js" as="script" /><link rel="prefetch" href="/assets/04.Fiber是什么.html.f784bba3.js" as="script" /><link rel="prefetch" href="/assets/05.双缓冲策略.html.2e651b1f.js" as="script" /><link rel="prefetch" href="/assets/06.什么是工作循环.html.59fe3cee.js" as="script" /><link rel="prefetch" href="/assets/07.什么是并发模式.html.7e908706.js" as="script" /><link rel="prefetch" href="/assets/08.思考题及解答.html.2cb70c22.js" as="script" /><link rel="prefetch" href="/assets/09.小结.html.d925967a.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c871d2e2.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.6ea9422d.js" as="script" /><link rel="prefetch" href="/assets/03.jsx代码实现.html.2d6a50ab.js" as="script" /><link rel="prefetch" href="/assets/04.createRoot.html.2614bca8.js" as="script" /><link rel="prefetch" href="/assets/05.render函数的阶段划分.html.f47defce.js" as="script" /><link rel="prefetch" href="/assets/06.beginWork.html.77aa0a61.js" as="script" /><link rel="prefetch" href="/assets/07.completeWork.html.8e252c3c.js" as="script" /><link rel="prefetch" href="/assets/08.commitWork.html.41fa9bde.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.2c9c92bc.js" as="script" /><link rel="prefetch" href="/assets/10.函数组件的初始化.html.013cf3e2.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.f6bb4986.js" as="script" /><link rel="prefetch" href="/assets/12.小结.html.2bb91b5e.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.e878169d.js" as="script" /><link rel="prefetch" href="/assets/02.domdiff思路分析.html.ff56b49e.js" as="script" /><link rel="prefetch" href="/assets/03.单节点domdiff.html.b087761c.js" as="script" /><link rel="prefetch" href="/assets/04.多节点domdiff.html.44e670a7.js" as="script" /><link rel="prefetch" href="/assets/05.思考题.html.f1f6116d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.4ec62a06.js" as="script" /><link rel="prefetch" href="/assets/02.事件系统实现思路分析.html.8d98d6cb.js" as="script" /><link rel="prefetch" href="/assets/03.事件名注册.html.256c44ef.js" as="script" /><link rel="prefetch" href="/assets/04.注册监听事件.html.32e87da2.js" as="script" /><link rel="prefetch" href="/assets/05.派发事件的主要逻辑.html.cd6fd3b2.js" as="script" /><link rel="prefetch" href="/assets/06.收集注册的函数.html.08594967.js" as="script" /><link rel="prefetch" href="/assets/07.合成事件.html.67c4f89b.js" as="script" /><link rel="prefetch" href="/assets/08.注册事件的回调.html.be697f66.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.791e76ea.js" as="script" /><link rel="prefetch" href="/assets/10.思考题.html.17a524d5.js" as="script" /><link rel="prefetch" href="/assets/11.小结.html.7f324403.js" as="script" /><link rel="prefetch" href="/assets/introduction.html.6859cccd.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.0ada0da1.js" as="script" /><link rel="prefetch" href="/assets/02.useReducer挂载.html.9199073b.js" as="script" /><link rel="prefetch" href="/assets/03.useReducer触发更新.html.74a19eee.js" as="script" /><link rel="prefetch" href="/assets/04.useReducer更新渲染1.html.9fc04de4.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer更新渲染2.html.4bc6a7ed.js" as="script" /><link rel="prefetch" href="/assets/06.useState源码实现.html.7865f484.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect挂载实现.html.d35c82a4.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect更新实现.html.72b52a42.js" as="script" /><link rel="prefetch" href="/assets/09.useLayoutEffect源码实现.html.13881dac.js" as="script" /><link rel="prefetch" href="/assets/10.代码调试.html.da8e9233.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.5cec2d5b.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.eca6cfe8.js" as="script" /><link rel="prefetch" href="/assets/02.二进制基础计算.html.bc129849.js" as="script" /><link rel="prefetch" href="/assets/03.最小堆算法.html.3f81952c.js" as="script" /><link rel="prefetch" href="/assets/04.React18的优先级体系.html.866eda4c.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.d8648cd3.js" as="script" /><link rel="prefetch" href="/assets/02.调度核心逻辑.html.0ca7ccee.js" as="script" /><link rel="prefetch" href="/assets/03.任务优先级与事件优先级.html.200dfaed.js" as="script" /><link rel="prefetch" href="/assets/04.lane模型下的更新队列.html.56c76bd7.js" as="script" /><link rel="prefetch" href="/assets/05.加入优先级的初始化渲染.html.7d586f05.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c07c856d.js" as="script" /><link rel="prefetch" href="/assets/02.同步渲染.html.2303e51a.js" as="script" /><link rel="prefetch" href="/assets/03.并发渲染.html.b2ddab47.js" as="script" /><link rel="prefetch" href="/assets/04.思考题.html.a1920c62.js" as="script" /><link rel="prefetch" href="/assets/404.html.c3e557d0.js" as="script" /><link rel="prefetch" href="/assets/index.html.89cc33f6.js" as="script" /><link rel="prefetch" href="/assets/README_en.html.84f0036a.js" as="script" /><link rel="prefetch" href="/assets/index.html.c84bff7c.js" as="script" /><link rel="prefetch" href="/assets/01.乾坤的Js隔离机制原理剖析（快照沙箱、两种代理沙箱）.html.1ee7fd7a.js" as="script" /><link rel="prefetch" href="/assets/02.乾坤的微应用加载流程分析(从微应用的注册到loadApp方法内部实现).html.5b3f4266.js" as="script" /><link rel="prefetch" href="/assets/03.乾坤的沙箱容器分析（Js沙箱机制建立后的具体应用）.html.d0c824db.js" as="script" /><link rel="prefetch" href="/assets/04.乾坤的资源加载机制(import-html-entry的内部实现).html.906fc8e8.js" as="script" /><link rel="prefetch" href="/assets/05.乾坤loadMicroApp方法实现以及数据通信机制分析.html.ec70d8ad.js" as="script" /><link rel="prefetch" href="/assets/06.single-spa的注册机制.html.e189f454.js" as="script" /><link rel="prefetch" href="/assets/07.对single-spa的路由管理及微应用状态管理的分析.html.67a8ca74.js" as="script" /><link rel="prefetch" href="/assets/08.single-spa中的reroute函数.html.89c7c707.js" as="script" /><link rel="prefetch" href="/assets/index.html.15c444e8.js" as="script" /><link rel="prefetch" href="/assets/index.html.5d3a91ee.js" as="script" /><link rel="prefetch" href="/assets/01.代码管理策略-monorepo.html.c2e2c820.js" as="script" /><link rel="prefetch" href="/assets/02.项目构建流程和源码调试方法.html.3282e77f.js" as="script" /><link rel="prefetch" href="/assets/03.Vue3响应式核心原理.html.8a9c8961.js" as="script" /><link rel="prefetch" href="/assets/04.Vue3响应式系统源码实现1.html.9d83f864.js" as="script" /><link rel="prefetch" href="/assets/05.Vue3响应式系统源码实现2.html.74ee8061.js" as="script" /><link rel="prefetch" href="/assets/06.reactive、ref相关api源码实现.html.888eb487.js" as="script" /><link rel="prefetch" href="/assets/07.故事要从createApp讲起.html.45de6932.js" as="script" /><link rel="prefetch" href="/assets/09.组件渲染和更新流程.html.7258787b.js" as="script" /><link rel="prefetch" href="/assets/10.名动江湖的diff算法.html.a4ef9218.js" as="script" /><link rel="prefetch" href="/assets/11.编译优化之Block Tree 与 PatchFlags.html.19bcffa2.js" as="script" /><link rel="prefetch" href="/assets/12.编译过程介绍及分析模版AST的生成过程.html.70ddd11f.js" as="script" /><link rel="prefetch" href="/assets/13.从AST到render函数（transform与代码生成）.html.badb7ce3.js" as="script" /><link rel="prefetch" href="/assets/index.html.9a18f450.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.db6305aa.js" as="script" /><link rel="prefetch" href="/assets/02.树立正确的源码观.html.e8177fff.js" as="script" /><link rel="prefetch" href="/assets/03.React是什么.html.c9b33731.js" as="script" /><link rel="prefetch" href="/assets/04.React架构演进过程.html.18d16927.js" as="script" /><link rel="prefetch" href="/assets/05.树立数据结构与算法的意识.html.545a6593.js" as="script" /><link rel="prefetch" href="/assets/06.树立用原子视角看问题的意识.html.35bc7bd0.js" as="script" /><link rel="prefetch" href="/assets/07.React18源码学习方法.html.53e7108c.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.74229be0.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.d494ae95.js" as="script" /><link rel="prefetch" href="/assets/03.虚拟DOM与真实DOM的实况对比.html.be080bed.js" as="script" /><link rel="prefetch" href="/assets/04.JSX相关概念和原理.html.caf18a28.js" as="script" /><link rel="prefetch" href="/assets/05.React和ReactDOM职责划分.html.542435cf.js" as="script" /><link rel="prefetch" href="/assets/06.createElement代码实现.html.695331ee.js" as="script" /><link rel="prefetch" href="/assets/07.实现 render、mount 和 createDOM进行初次渲染.html.198ee6cd.js" as="script" /><link rel="prefetch" href="/assets/08.实现函数setPropsForDOM为DOM设置属性.html.23680fa5.js" as="script" /><link rel="prefetch" href="/assets/09.调试初始化渲染过程.html.6ed397cc.js" as="script" /><link rel="prefetch" href="/assets/10.思考题与解答.html.d985ae1a.js" as="script" /><link rel="prefetch" href="/assets/11.本章小结.html.d6f9b19d.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.921c6ae5.js" as="script" /><link rel="prefetch" href="/assets/02.函数组件与类组件介绍.html.00928639.js" as="script" /><link rel="prefetch" href="/assets/03.实现函数组件基础功能.html.466b2327.js" as="script" /><link rel="prefetch" href="/assets/04.实现类组件基础功能.html.b8f38ada.js" as="script" /><link rel="prefetch" href="/assets/05.类组件的更新机制分析.html.6ac5b42f.js" as="script" /><link rel="prefetch" href="/assets/06.实现类组件的setState方法.html.ef7f97c9.js" as="script" /><link rel="prefetch" href="/assets/07.事件合成机制原理分析.html.283eff7f.js" as="script" /><link rel="prefetch" href="/assets/08.事件合成机制的简单实现.html.ea0f98fd.js" as="script" /><link rel="prefetch" href="/assets/09.ref的原理分析.html.b184df2c.js" as="script" /><link rel="prefetch" href="/assets/10.类组件的ref源码实现.html.8fb9f516.js" as="script" /><link rel="prefetch" href="/assets/11.引入forwardRef的底层逻辑.html.58fcfa0e.js" as="script" /><link rel="prefetch" href="/assets/12.实现forwardRef为函数组件提供ref的能力.html.2070c6ac.js" as="script" /><link rel="prefetch" href="/assets/13.调试函数组件与类组件相关代码.html.8cb40f1d.js" as="script" /><link rel="prefetch" href="/assets/14.思考题与解答.html.60fbb04a.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.2c4b2a71.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.f910672b.js" as="script" /><link rel="prefetch" href="/assets/02.React DOM DIFF原理.html.df4ea08d.js" as="script" /><link rel="prefetch" href="/assets/03.React DOM DIFF算法源码实现.html.8b8da8c0.js" as="script" /><link rel="prefetch" href="/assets/04.调试DOM DIFF算法.html.fe4a13ac.js" as="script" /><link rel="prefetch" href="/assets/05.思考题及解答.html.dc9488b1.js" as="script" /><link rel="prefetch" href="/assets/06.本章小结.html.29ccadb8.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.a6d21d9d.js" as="script" /><link rel="prefetch" href="/assets/02.生命周期的内涵.html.66f202b1.js" as="script" /><link rel="prefetch" href="/assets/03.生命周期图观察.html.0bcbfe1b.js" as="script" /><link rel="prefetch" href="/assets/04.常用生命周期函数应用案例.html.cd60a2f5.js" as="script" /><link rel="prefetch" href="/assets/05.常用生命周期函数源码实现.html.87697117.js" as="script" /><link rel="prefetch" href="/assets/06.shouldComponentUpdate案例.html.3e0dddd1.js" as="script" /><link rel="prefetch" href="/assets/07.shouldComponentUpdate实现.html.dc437ab8.js" as="script" /><link rel="prefetch" href="/assets/08.getDeriveStateFromProp案例.html.b6a92902.js" as="script" /><link rel="prefetch" href="/assets/09.getDeriveStateFromProps源码实现.html.20f32264.js" as="script" /><link rel="prefetch" href="/assets/10.getSnapshotBeforeUpdate应用案例.html.7feefdcc.js" as="script" /><link rel="prefetch" href="/assets/11.getSnapshotBeforeUpdate源码实现.html.f5a4b5e1.js" as="script" /><link rel="prefetch" href="/assets/12.生命周期相关代码调试.html.64f46698.js" as="script" /><link rel="prefetch" href="/assets/13.思考题及解答.html.5b7f53a5.js" as="script" /><link rel="prefetch" href="/assets/14.本章小结.html.ef52a9dd.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.c5ec0a7b.js" as="script" /><link rel="prefetch" href="/assets/02.PureComponent应用案例.html.a9709cc2.js" as="script" /><link rel="prefetch" href="/assets/03.PureComponent源码实现.html.bd7b9e82.js" as="script" /><link rel="prefetch" href="/assets/04.memo应用案例.html.802a6f41.js" as="script" /><link rel="prefetch" href="/assets/05.memo源码实现.html.e5f8c2b9.js" as="script" /><link rel="prefetch" href="/assets/06.调试PureComponent及memo相关的代码.html.07cc3773.js" as="script" /><link rel="prefetch" href="/assets/07.思考题及解答.html.9d7b60e0.js" as="script" /><link rel="prefetch" href="/assets/08.本章小结.html.fe78563e.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.72466b45.js" as="script" /><link rel="prefetch" href="/assets/02.Hooks存在的意义.html.6c997232.js" as="script" /><link rel="prefetch" href="/assets/03.useState应用案例.html.56b93e40.js" as="script" /><link rel="prefetch" href="/assets/04.useState源码实现.html.7b1282f9.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer应用案例.html.6ff43ce4.js" as="script" /><link rel="prefetch" href="/assets/06.useReducer源码实现.html.b7231485.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect及useLayoutEffect应用案例.html.11b64e3d.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect及useLayoutEffect源码实现.html.394388ee.js" as="script" /><link rel="prefetch" href="/assets/09.useRef应用案例及源码实现.html.cf86b6a9.js" as="script" /><link rel="prefetch" href="/assets/10.useImperativeHandle应用案例及源码实现.html.fcbdced0.js" as="script" /><link rel="prefetch" href="/assets/11.useMemo及useCallback应用案例.html.36542244.js" as="script" /><link rel="prefetch" href="/assets/12.useMemo及useCallback源码实现.html.9969e023.js" as="script" /><link rel="prefetch" href="/assets/13.Hooks相关源码调试.html.2e233d3b.js" as="script" /><link rel="prefetch" href="/assets/14.思考题及解答.html.0575a3d3.js" as="script" /><link rel="prefetch" href="/assets/15.本章小结.html.86df1b48.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.529661d0.js" as="script" /><link rel="prefetch" href="/assets/02.为什么需要Fiber架构.html.84d9ce25.js" as="script" /><link rel="prefetch" href="/assets/03.Fiber架构是什么.html.a0d191c9.js" as="script" /><link rel="prefetch" href="/assets/04.Fiber是什么.html.1ac0366e.js" as="script" /><link rel="prefetch" href="/assets/05.双缓冲策略.html.8f2eb032.js" as="script" /><link rel="prefetch" href="/assets/06.什么是工作循环.html.250cd161.js" as="script" /><link rel="prefetch" href="/assets/07.什么是并发模式.html.12d45151.js" as="script" /><link rel="prefetch" href="/assets/08.思考题及解答.html.b5514550.js" as="script" /><link rel="prefetch" href="/assets/09.小结.html.090cd636.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.b0e37599.js" as="script" /><link rel="prefetch" href="/assets/02.环境准备.html.1aac552b.js" as="script" /><link rel="prefetch" href="/assets/03.jsx代码实现.html.56dace02.js" as="script" /><link rel="prefetch" href="/assets/04.createRoot.html.73b532a1.js" as="script" /><link rel="prefetch" href="/assets/05.render函数的阶段划分.html.3c0b5b27.js" as="script" /><link rel="prefetch" href="/assets/06.beginWork.html.ca98d287.js" as="script" /><link rel="prefetch" href="/assets/07.completeWork.html.3632d2e5.js" as="script" /><link rel="prefetch" href="/assets/08.commitWork.html.b2ea0c38.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.bf6e2e1d.js" as="script" /><link rel="prefetch" href="/assets/10.函数组件的初始化.html.fad423eb.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.26c95030.js" as="script" /><link rel="prefetch" href="/assets/12.小结.html.560f1966.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.afb11380.js" as="script" /><link rel="prefetch" href="/assets/02.domdiff思路分析.html.c0454dbc.js" as="script" /><link rel="prefetch" href="/assets/03.单节点domdiff.html.66036d0b.js" as="script" /><link rel="prefetch" href="/assets/04.多节点domdiff.html.bf152796.js" as="script" /><link rel="prefetch" href="/assets/05.思考题.html.1d65c5bb.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.56645127.js" as="script" /><link rel="prefetch" href="/assets/02.事件系统实现思路分析.html.ec9cdcc6.js" as="script" /><link rel="prefetch" href="/assets/03.事件名注册.html.a17f87d1.js" as="script" /><link rel="prefetch" href="/assets/04.注册监听事件.html.f29490c9.js" as="script" /><link rel="prefetch" href="/assets/05.派发事件的主要逻辑.html.3ce8a659.js" as="script" /><link rel="prefetch" href="/assets/06.收集注册的函数.html.dcc3da2d.js" as="script" /><link rel="prefetch" href="/assets/07.合成事件.html.32fcd4ab.js" as="script" /><link rel="prefetch" href="/assets/08.注册事件的回调.html.ea39e021.js" as="script" /><link rel="prefetch" href="/assets/09.代码调试.html.d73d159d.js" as="script" /><link rel="prefetch" href="/assets/10.思考题.html.93d10c2e.js" as="script" /><link rel="prefetch" href="/assets/11.小结.html.1ea9f75e.js" as="script" /><link rel="prefetch" href="/assets/introduction.html.a87a35ed.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.42030292.js" as="script" /><link rel="prefetch" href="/assets/02.useReducer挂载.html.44b5dbd4.js" as="script" /><link rel="prefetch" href="/assets/03.useReducer触发更新.html.e5ce9fe8.js" as="script" /><link rel="prefetch" href="/assets/04.useReducer更新渲染1.html.368cd6f5.js" as="script" /><link rel="prefetch" href="/assets/05.useReducer更新渲染2.html.aac12be6.js" as="script" /><link rel="prefetch" href="/assets/06.useState源码实现.html.94e56841.js" as="script" /><link rel="prefetch" href="/assets/07.useEffect挂载实现.html.fe9574df.js" as="script" /><link rel="prefetch" href="/assets/08.useEffect更新实现.html.30b0ff68.js" as="script" /><link rel="prefetch" href="/assets/09.useLayoutEffect源码实现.html.32bfc61a.js" as="script" /><link rel="prefetch" href="/assets/10.代码调试.html.3d5760c7.js" as="script" /><link rel="prefetch" href="/assets/11.思考题.html.7440cdc8.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.0cf5c9f0.js" as="script" /><link rel="prefetch" href="/assets/02.二进制基础计算.html.85fe758f.js" as="script" /><link rel="prefetch" href="/assets/03.最小堆算法.html.42e49b74.js" as="script" /><link rel="prefetch" href="/assets/04.React18的优先级体系.html.c900653e.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.7ea78b24.js" as="script" /><link rel="prefetch" href="/assets/02.调度核心逻辑.html.ce7fbb15.js" as="script" /><link rel="prefetch" href="/assets/03.任务优先级与事件优先级.html.9749f6fc.js" as="script" /><link rel="prefetch" href="/assets/04.lane模型下的更新队列.html.98eb996a.js" as="script" /><link rel="prefetch" href="/assets/05.加入优先级的初始化渲染.html.c5f4d3a9.js" as="script" /><link rel="prefetch" href="/assets/01.本章介绍.html.72ab6fd7.js" as="script" /><link rel="prefetch" href="/assets/02.同步渲染.html.1d0a4f73.js" as="script" /><link rel="prefetch" href="/assets/03.并发渲染.html.621febf1.js" as="script" /><link rel="prefetch" href="/assets/04.思考题.html.196c436a.js" as="script" /><link rel="prefetch" href="/assets/404.html.2c69ae1e.js" as="script" /><link rel="prefetch" href="/assets/giscus.06b5451c.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/developer.jpeg" alt="杨艺韬讲堂"><span class="site-name can-hide">杨艺韬讲堂</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/react18/" class="" aria-label="手写React源码"><!--[--><!--]--> 手写React源码 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue3/" class="router-link-active" aria-label="Vue3源码剖析"><!--[--><!--]--> Vue3源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/microfe/" class="" aria-label="微前端源码剖析"><!--[--><!--]--> 微前端源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://www.github.com/yangyitao100" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/react18/" class="" aria-label="手写React源码"><!--[--><!--]--> 手写React源码 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue3/" class="router-link-active" aria-label="Vue3源码剖析"><!--[--><!--]--> Vue3源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/microfe/" class="" aria-label="微前端源码剖析"><!--[--><!--]--> 微前端源码剖析 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://www.github.com/yangyitao100" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/vue3/README.md" class="sidebar-item sidebar-heading active" aria-label="Vue3源码剖析"><!--[--><!--]--> Vue3源码剖析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vue3/01.%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5-monorepo.html" class="sidebar-item" aria-label="01.代码管理策略-monorepo"><!--[--><!--]--> 01.代码管理策略-monorepo <!--[--><!--]--></a><!----></li><li><a href="/vue3/02.%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%92%8C%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95.html" class="sidebar-item" aria-label="02.项目构建流程和源码调试方法"><!--[--><!--]--> 02.项目构建流程和源码调试方法 <!--[--><!--]--></a><!----></li><li><a href="/vue3/03.Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html" class="sidebar-item" aria-label="03.Vue3响应式核心原理"><!--[--><!--]--> 03.Vue3响应式核心原理 <!--[--><!--]--></a><!----></li><li><a href="/vue3/04.Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B01.html" class="sidebar-item" aria-label="04.Vue3响应式系统源码实现1"><!--[--><!--]--> 04.Vue3响应式系统源码实现1 <!--[--><!--]--></a><!----></li><li><a href="/vue3/05.Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B02.html" class="sidebar-item" aria-label="05.Vue3响应式系统源码实现2"><!--[--><!--]--> 05.Vue3响应式系统源码实现2 <!--[--><!--]--></a><!----></li><li><a href="/vue3/06.reactive%E3%80%81ref%E7%9B%B8%E5%85%B3api%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0.html" class="sidebar-item" aria-label="06.reactive、ref相关api源码实现"><!--[--><!--]--> 06.reactive、ref相关api源码实现 <!--[--><!--]--></a><!----></li><li><a href="/vue3/07.%E6%95%85%E4%BA%8B%E8%A6%81%E4%BB%8EcreateApp%E8%AE%B2%E8%B5%B7.html" class="sidebar-item" aria-label="07.故事要从createApp讲起"><!--[--><!--]--> 07.故事要从createApp讲起 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="08.虚拟Node到真实Node的路其实很长"><!--[--><!--]--> 08.虚拟Node到真实Node的路其实很长 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#patch函数的使命" class="router-link-active router-link-exact-active sidebar-item" aria-label="patch函数的使命"><!--[--><!--]--> patch函数的使命 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#类型判断方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="类型判断方式"><!--[--><!--]--> 类型判断方式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#processtext" class="router-link-active router-link-exact-active sidebar-item" aria-label="processText"><!--[--><!--]--> processText <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#processcommentnode" class="router-link-active router-link-exact-active sidebar-item" aria-label="processCommentNode"><!--[--><!--]--> processCommentNode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#mountstaticnode" class="router-link-active router-link-exact-active sidebar-item" aria-label="mountStaticNode"><!--[--><!--]--> mountStaticNode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#patchstaticnode" class="router-link-active router-link-exact-active sidebar-item" aria-label="patchStaticNode"><!--[--><!--]--> patchStaticNode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#processfragment、processcomponent" class="router-link-active router-link-exact-active sidebar-item" aria-label="processFragment、processComponent"><!--[--><!--]--> processFragment、processComponent <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#setref" class="router-link-active router-link-exact-active sidebar-item" aria-label="setRef"><!--[--><!--]--> setRef <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue3/08.%E8%99%9A%E6%8B%9FNode%E5%88%B0%E7%9C%9F%E5%AE%9ENode%E7%9A%84%E8%B7%AF%E5%85%B6%E5%AE%9E%E5%BE%88%E9%95%BF.html#写在最后" class="router-link-active router-link-exact-active sidebar-item" aria-label="写在最后"><!--[--><!--]--> 写在最后 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/vue3/09.%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%92%8C%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.html" class="sidebar-item" aria-label="09.组件渲染和更新流程"><!--[--><!--]--> 09.组件渲染和更新流程 <!--[--><!--]--></a><!----></li><li><a href="/vue3/10.%E5%90%8D%E5%8A%A8%E6%B1%9F%E6%B9%96%E7%9A%84diff%E7%AE%97%E6%B3%95.html" class="sidebar-item" aria-label="10.名动江湖的diff算法"><!--[--><!--]--> 10.名动江湖的diff算法 <!--[--><!--]--></a><!----></li><li><a href="/vue3/11.%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E4%B9%8BBlock%20Tree%20%E4%B8%8E%20PatchFlags.html" class="sidebar-item" aria-label="11.编译优化之Block Tree 与 PatchFlags"><!--[--><!--]--> 11.编译优化之Block Tree 与 PatchFlags <!--[--><!--]--></a><!----></li><li><a href="/vue3/12.%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%88%86%E6%9E%90%E6%A8%A1%E7%89%88AST%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B.html" class="sidebar-item" aria-label="12.编译过程介绍及分析模版AST的生成过程"><!--[--><!--]--> 12.编译过程介绍及分析模版AST的生成过程 <!--[--><!--]--></a><!----></li><li><a href="/vue3/13.%E4%BB%8EAST%E5%88%B0render%E5%87%BD%E6%95%B0%EF%BC%88transform%E4%B8%8E%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%EF%BC%89.html" class="sidebar-item" aria-label="13.从AST到render函数（transform与代码生成）"><!--[--><!--]--> 13.从AST到render函数（transform与代码生成） <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="_08-虚拟node到真实node的路其实很长" tabindex="-1"><a class="header-anchor" href="#_08-虚拟node到真实node的路其实很长" aria-hidden="true">#</a> 08.虚拟Node到真实Node的路其实很长</h1><p>前面我们知道了，从<strong>虚拟Node</strong>到<strong>真实Node</strong>是借助一个叫做<code>render</code>的函数来完成。本文会带着大家进入<code>render</code>函数，先从从总体上把握<strong>Vue3</strong>的渲染核心流程以及部分源码实现细节。至于比较重要的一些细节，比如组件如何渲染如何更新，<strong>diff算法</strong>具体如何实现，将在后续的文章一一进行分析。</p><h1 id="render函数" tabindex="-1"><a class="header-anchor" href="#render函数" aria-hidden="true">#</a> <code>render</code>函数</h1><p>先直接看<code>render</code>函数的代码实现：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段1</span>
<span class="token keyword">const</span> render<span class="token operator">:</span> <span class="token function-variable function">RootRenderFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unmount</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">flushPostFlushCbs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    container<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们先来看看该函数的参数，第一个参数是<strong>虚拟Node</strong>对象，第二个参数是一个<code>Element</code>对象，第三个参数暂时先忽略。<code>render</code>函数的内部逻辑也很简单，做了下面几件事情：</p><ol><li>如果传入的<strong>虚拟Node</strong>对象是空，则判断<code>container</code>对应的元素曾经是否渲染过其他<strong>虚拟Node</strong>，如果是则从<code>container</code>上卸载该<strong>虚拟Node</strong>对应的节点，如果不是则什么都不做，将<code>container._vnode</code>置空即可。<code>container._vnode</code>中的值来源于<code>render</code>函数的最后一行代码；</li><li>如果传入的<strong>虚拟Node</strong>不为空，则需要和<code>container</code>元素上挂载过的<code>_vnode</code>所代表的<strong>DOM</strong>元素进行比较并修改当前的真实<strong>DOM</strong>树，这个逻辑都由<code>patch</code>函数来实现，也是本文的重点内容；</li><li>执行<code>flushPostFlushCbs</code>将保存在数组<code>pendingPostFlushCbs</code>中的函数依次执行，至于什么时候给数组<code>pendingPostFlushCbs</code>中添加元素，具体又是如何执行的这些函数，本文暂时不讲，后续的文章中如有必要会用一小节来介绍。</li></ol><h1 id="patch才是灵魂" tabindex="-1"><a class="header-anchor" href="#patch才是灵魂" aria-hidden="true">#</a> <code>patch</code>才是灵魂</h1><p><strong>Vue3</strong>的渲染流程，虽然是通过调用<code>render</code>函数实现，但<code>patch</code>才是整个渲染流程的灵魂。我们来看看<code>patch</code>函数的具体实现：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段2</span>
<span class="token keyword">const</span> patch<span class="token operator">:</span> <span class="token function-variable function">PatchFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    n1<span class="token punctuation">,</span>
    n2<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isSVG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    slotScopeIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    optimized <span class="token operator">=</span> __DEV__ <span class="token operator">&amp;&amp;</span> isHmrUpdating <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>n2<span class="token punctuation">.</span>dynamicChildren
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// patching &amp; not same type, unmount old tree</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      anchor <span class="token operator">=</span> <span class="token function">getNextHostNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
      <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      n1 <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>patchFlag <span class="token operator">===</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">BAIL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      optimized <span class="token operator">=</span> <span class="token boolean">false</span>
      n2<span class="token punctuation">.</span>dynamicChildren <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Text<span class="token operator">:</span>
        <span class="token function">processText</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Comment<span class="token operator">:</span>
        <span class="token function">processCommentNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Static<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">mountStaticNode</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">patchStaticNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
        <span class="token function">processFragment</span><span class="token punctuation">(</span>
         <span class="token comment">// 此处省略若干代码...</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">processElement</span><span class="token punctuation">(</span>
            <span class="token comment">// 此处省略若干代码...</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">processComponent</span><span class="token punctuation">(</span>
            <span class="token comment">// 此处省略若干代码...</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token keyword">typeof</span> TeleportImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
            <span class="token comment">// 此处省略若干代码...</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token keyword">typeof</span> SuspenseImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
            <span class="token comment">// 此处省略若干代码...</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Invalid VNode type:&#39;</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> <span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// set ref</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parentComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> n2 <span class="token operator">||</span> n1<span class="token punctuation">,</span> <span class="token operator">!</span>n2<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>patch</code>函数内部根据传入的<strong>虚拟Node</strong>的类型不同，会分别调用不同的函数进行处理。这里面有两个点值得我们关注：</p><ol><li>搞清楚<code>patch</code>函数的使命；</li><li>通过位运算的方式来进行类型判断；</li></ol><h2 id="patch函数的使命" tabindex="-1"><a class="header-anchor" href="#patch函数的使命" aria-hidden="true">#</a> <code>patch</code>函数的使命</h2><p>可能大家会觉得奇怪，刚才不是已经讲过了<code>patch</code>函数的主要逻辑就是根据<strong>虚拟Node</strong>的不同类型来调用不同的函数来进行处理吗？还有什么使命？没错，<code>patch</code>函数的逻辑很清晰，但是我想在这里强调，<code>patch</code>存在的根本意义是寻找<strong>新虚拟Node</strong>和当前<strong>真实Node</strong>对应的<strong>旧虚拟Node</strong>的差异，并根据这种差异修改<strong>DOM树</strong>以抹平这种差异。理解了这个就能很轻松的理解，为什么有这样的语句：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段3</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为新旧<strong>虚拟Node</strong>没有差异，当然也就没有继续进行的必要了。我们也能轻松的理解下面的代码：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段4</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  anchor <span class="token operator">=</span> <span class="token function">getNextHostNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
  <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  n1 <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果<strong>旧虚拟Node</strong>存在，而且<strong>新虚拟Node</strong>和<strong>旧虚拟Node</strong>的类型不一致，则卸载<strong>旧虚拟Node</strong>，同时将该<strong>旧虚拟Node</strong>置为空。会发现这里有个<code>anchor</code>变量，如果该<code>anchor</code>始终为<code>null</code>则会导致我们新插入元素的时候始终是在尾部，与其所替换的元素的位置不一致，所以需要在卸载<strong>旧虚拟Node</strong>对应的<strong>真实Node</strong>之前，用<code>anchor</code>记录其下一个元素。</p><p>同时我们理解了<code>patch</code>函数的使命，可以尝试想象如果让我们来实现<code>patch</code>函数该怎么做，可能我们很自然的想到，完全可以直接把旧节点删除，插入新节点的内容即可，实现相同的功能可以将几千行代码简化到几行完成，看似低级的实现却也让我们认清了<code>patch</code>函数的本质。在本文的后半部分，会介绍<code>patch</code>函数中调用的很多其他函数，相信有了我们前面的认识可以更好的理解<strong>Vue3</strong>为什么要这么实现<code>patch</code>函数。</p><h2 id="类型判断方式" tabindex="-1"><a class="header-anchor" href="#类型判断方式" aria-hidden="true">#</a> 类型判断方式</h2><p>我们发现代码片段<strong>2</strong>中有几处形如<code>if (shapeFlag &amp; ShapeFlags.ELEMENT)</code>的代码，为什么要这么判断呢？要回答这个问题，我们先看看<code>shapeFlag</code>是什么，<code>ShapeFlags.ELEMENT</code>是从哪里来的。</p><p><code>shapeFlag</code>是从<code>patch</code>函数的第<strong>2</strong>个参数也就是<strong>新虚拟Node</strong>上解构出来的，该值是个数值类型。我们再来看看<code>ShapeFlags</code>的代码：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段5</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">{</span>
  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">FUNCTIONAL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token constant">SLOTS_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token constant">TELEPORT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token constant">SUSPENSE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT_SHOULD_KEEP_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT_KEPT_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT</span> <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从代码片段<strong>5</strong>中可以看见<code>ShapeFlags</code>是一个枚举类型。对位运算不了解的朋友可能已经充满了疑惑，为什么要这么表示？要回答这个问题，还得先了解位运算的左移、与、或运算。</p><p>假设我们有<strong>8</strong>个二进制位<code>00000000</code>，每一个二进制位表示<strong>小A</strong>是否具备一项能力，<code>1</code>表示具备，<code>0</code>表示不具备，具体能力映射如下。</p><table><thead><tr><th>篮球</th><th>足球</th><th>游泳</th><th>英语</th><th>喝酒</th><th>美食</th><th>跑步</th><th>开车</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody></table><p>如果小A会跑步可以这样描述：</p><table><thead><tr><th>篮球</th><th>足球</th><th>游泳</th><th>英语</th><th>喝酒</th><th>美食</th><th>跑步</th><th>开车</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td></tr></tbody></table><p>如果小A不仅会跑步还会喝酒，可以这样描述：</p><table><thead><tr><th>篮球</th><th>足球</th><th>游泳</th><th>英语</th><th>喝酒</th><th>美食</th><th>跑步</th><th>开车</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td><code>1</code></td><td>0</td></tr></tbody></table><p>基于上面的认知，我们可以把不同状态这样来表示：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// xiaoAState为0，表示小A，什么技能都不会</span>
<span class="token keyword">let</span> xiaoAState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 0 0 0 0 0 0 0 0</span>
<span class="token keyword">const</span> <span class="token constant">DRIVE_CAR</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 0 0 0 0 0 0 0 1</span>
<span class="token keyword">const</span> <span class="token constant">RUN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 0 0 0 0 0 0 1 0</span>
<span class="token keyword">const</span> <span class="token constant">FOOD</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 0 0 0 0 0 1 0 0</span>
<span class="token keyword">const</span> <span class="token constant">DRINK</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">// 0 0 0 0 1 0 0 0</span>

<span class="token comment">// 让小A具备喝酒的能力，可以这样进行运算：</span>
xiaoAState <span class="token operator">|=</span> <span class="token constant">DRINK</span><span class="token punctuation">;</span> <span class="token comment">// 0 0 0 0 1 0 0 0</span>
<span class="token comment">// 让小A具备跑步的能力，可以这样运算：</span>
xiaoAState <span class="token operator">|=</span> <span class="token constant">RUN</span><span class="token punctuation">;</span>   <span class="token comment">// 0 0 0 0 1 0 1 0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或运算可以下面的表格进行理解：</p><table><thead><tr><th>篮球</th><th>足球</th><th>游泳</th><th>英语</th><th>喝酒</th><th>美食</th><th>跑步</th><th>开车</th><th><code>运算符号</code></th><th><code>含义</code></th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td>0</td><td>0</td><td></td><td><code>DRINK</code></td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td><code>或</code></td><td><code>RUN</code></td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td><code>1</code></td><td>0</td><td></td><td><code>结果</code></td></tr></tbody></table><p>当我们想判断小A是否具备某项能力的时候可以借助于<code>&amp;</code>运算，例如：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">if</span><span class="token punctuation">(</span>xiaoAState <span class="token operator">&amp;</span> <span class="token constant">DRINK</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;小A确实会喝酒&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>xiaoAState <span class="token operator">&amp;</span> <span class="token constant">FOOD</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;小A会做饭&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;小A不会做饭&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么可以这样判断呢，我们先来看看，<code>xiaoAState &amp; FOOD</code>的示意：</p><table><thead><tr><th>篮球</th><th>足球</th><th>游泳</th><th>英语</th><th>喝酒</th><th>美食</th><th>跑步</th><th>开车</th><th><code>运算符号</code></th><th><code>含义</code></th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td><code>1</code></td><td>0</td><td></td><td><code>xiaoAState</code></td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td><code>1</code></td><td>0</td><td>0</td><td><code>&amp;</code></td><td><code>FOOD</code></td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td><code>0</code></td><td><code>0</code></td><td><code>0</code></td><td>0</td><td></td><td><code>结果</code></td></tr></tbody></table><p>不难发现<code>xiaoAState</code>和自己不具备的能力进行了<code>&amp;</code>运算之后，结果值是<code>0</code>，反之如果是和自己具备的能力进行<code>&amp;</code>运算，结果值就是<code>1</code>，这也就是为什么能够通过<code>&amp;</code>运算来判断<code>xiaoAState</code>是否具备某个能力的原理。到了这里也就不难发现代码片段<code>5</code>为什么要以<code>1</code>为初始值，然后不断左移<code>1</code>位，一切都是为了方便计算。同时这种方式可以让一个属性值表示多个状态，就像上文示范的<code>xiaoAState</code>不仅可以表示具备喝酒的能力还可以表示具备跑步的能力或者其他很多的能力。不得不说这种方式很巧妙，而且性能也比较高，在实际工作中类似场景完全可以借鉴。</p><p>下面我们开始探索<code>patch</code>函数内部调用的其他函：</p><h2 id="processtext" tabindex="-1"><a class="header-anchor" href="#processtext" aria-hidden="true">#</a> <code>processText</code></h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段6</span>
<span class="token keyword">const</span> processText<span class="token operator">:</span> <span class="token function-variable function">ProcessTextOrCommentFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">hostInsert</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateText</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token operator">!==</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">hostSetText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑比较简单，如果<strong>旧虚拟Node</strong>为<code>null</code>，则直接将文本插入到容器即可，如果不为<code>null</code>，则说明需要进行更新。这里有三个点值得我们关注：</p><ol><li><code>hostInsert</code>、<code>hostSetText</code>从哪里来的呢？还记得我们在<code>runtime-dom</code>传入的参数<code>const rendererOptions = extend({ patchProp }, nodeOps)</code>吗，没错，具体对<code>DOM</code>节点进行删除、修改、增加都是<code>runtime-dom</code>或者其他平台传入的方法。<code>runtime-core</code>只需要关心将要对节点进行什么类型的操作，但这些操作具体怎么实现由传入的参数决定。这就是<code>runtime-core</code>平台无关的原因。</li><li>代码<code>n2.el = hostCreateText(n2.children as string)</code>可以看出<strong>虚拟Node</strong>的<code>el</code>属性，保存的是一个<code>DOM</code>对象，哪怕这个<code>DOM</code>对象是个文本也不例外。</li><li><code>const el = (n2.el = n1.el!)</code>这行代码比较巧妙，将<strong>旧虚拟Node</strong>的<code>el</code>属性值赋值给<strong>新虚拟Node</strong>的属性<code>el</code>，相当于在<strong>旧虚拟Node</strong>对应的<code>DOM</code>节点的基础上进行操作，而不是新创建节点，减少了性能消耗。</li></ol><h2 id="processcommentnode" tabindex="-1"><a class="header-anchor" href="#processcommentnode" aria-hidden="true">#</a> <code>processCommentNode</code></h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段7</span>
<span class="token keyword">const</span> processCommentNode<span class="token operator">:</span> <span class="token function-variable function">ProcessTextOrCommentFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    n1<span class="token punctuation">,</span>
    n2<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    anchor
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">hostInsert</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateComment</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// there&#39;s no support for dynamic comments</span>
      n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里逻辑比较简单，如果<strong>新虚拟Node</strong>是注释类型，则判断<strong>旧虚拟Node</strong>是否存在，如果不存在则直接执行插入操作。如果存在则直接将<strong>旧虚拟Node</strong>对应的<code>el</code>元素赋值给<strong>新虚拟Node</strong>的<code>el</code>，不做任何其他处理，因为<strong>Vue3</strong>中是不支持注释响应式发生变化，也就是说注释创建后不会被更改。</p><h2 id="mountstaticnode" tabindex="-1"><a class="header-anchor" href="#mountstaticnode" aria-hidden="true">#</a> <code>mountStaticNode</code></h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段8</span>
<span class="token keyword">const</span> <span class="token function-variable function">mountStaticNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
    container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
    anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// static nodes are only present when used with compiler-dom/runtime-dom</span>
    <span class="token comment">// which guarantees presence of hostInsertStaticContent.</span>
    <span class="token punctuation">;</span><span class="token punctuation">[</span>n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>anchor<span class="token punctuation">]</span> <span class="token operator">=</span> hostInsertStaticContent<span class="token operator">!</span><span class="token punctuation">(</span>
      n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      anchor<span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
      n2<span class="token punctuation">.</span>anchor
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mountStaticNode</code>的功能是将<strong>新虚拟Node</strong>的静态内容挂载到<code>container</code>上，处理方法也很简单，直接调用<code>runtime-dom</code>传入的函数<code>hostInsertStaticContent</code>。需要注意的两个细节如下：</p><ol><li>在平时编码的过程中，以<code>(</code>、<code>[</code>开头的表达式，前面应该加一个<code>;</code>以防止在代码被压缩后与上一行的内容拼接成属性访问语句。</li><li>不太清楚解构赋值的语法朋友对<code>[n2.el, n2.anchor] = xxx</code>的表示可能很疑惑，可以查阅<code>MDN</code>文档了解相关含义。</li></ol><h2 id="patchstaticnode" tabindex="-1"><a class="header-anchor" href="#patchstaticnode" aria-hidden="true">#</a> <code>patchStaticNode</code></h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段9</span>
<span class="token keyword">const</span> <span class="token function-variable function">patchStaticNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
    n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
    container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
    isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// static nodes are only patched during dev for HMR</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token operator">!==</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> anchor <span class="token operator">=</span> <span class="token function">hostNextSibling</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>anchor<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token comment">// remove existing</span>
      <span class="token function">removeStaticNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
      <span class="token comment">// insert new</span>
      <span class="token punctuation">;</span><span class="token punctuation">[</span>n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>anchor<span class="token punctuation">]</span> <span class="token operator">=</span> hostInsertStaticContent<span class="token operator">!</span><span class="token punctuation">(</span>
        n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor<span class="token punctuation">,</span>
        isSVG
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el
      n2<span class="token punctuation">.</span>anchor <span class="token operator">=</span> n1<span class="token punctuation">.</span>anchor
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数<code>patchStaticNode</code>只在开发环境下才有可能调用，为什么呢？因为既然是静态节点，就不存在响应式数据的变化也就不存在更新，所以也就不会调用这个函数。但是开发环境热更新的时候可能会变化相应数据，里面逻辑比较简单，如果还是觉得读起来有困难可以先跳过，不做重点掌握。</p><h2 id="processfragment、processcomponent" tabindex="-1"><a class="header-anchor" href="#processfragment、processcomponent" aria-hidden="true">#</a> <code>processFragment</code>、<code>processComponent</code></h2><p>关于函数<code>processFragment</code>、<code>processComponent</code>内部的流程，在后续的文章中进行分析。</p><h2 id="setref" tabindex="-1"><a class="header-anchor" href="#setref" aria-hidden="true">#</a> <code>setRef</code></h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段10</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parentComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> n2 <span class="token operator">||</span> n1<span class="token punctuation">,</span> <span class="token operator">!</span>n2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还记得我们在上一篇文章中介绍的关于通过<code>ref</code>获取子组件的内容吗，当时我们介绍了<code>getExposeProxy</code>的核心功能是保护子组件的内容不被父组件随意访问。在<code>patch</code>函数中调用了<code>setRef</code>，而<code>setRef</code>中则调用了<code>getExposeProxy</code>函数。我们看看<code>setRef</code>究竟做了什么：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 代码片段11</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setRef</span><span class="token punctuation">(</span>
  rawRef<span class="token operator">:</span> VNodeNormalizedRef<span class="token punctuation">,</span>
  oldRawRef<span class="token operator">:</span> VNodeNormalizedRef <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  isUnmount <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此处省略许多代码...</span>
  <span class="token keyword">const</span> refValue <span class="token operator">=</span>
    vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span>
      <span class="token operator">?</span> <span class="token function">getExposeProxy</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>component<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token operator">||</span> vnode<span class="token punctuation">.</span>component<span class="token operator">!</span><span class="token punctuation">.</span>proxy
      <span class="token operator">:</span> vnode<span class="token punctuation">.</span>el
  <span class="token keyword">const</span> value <span class="token operator">=</span> isUnmount <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> refValue

  <span class="token keyword">const</span> <span class="token punctuation">{</span> i<span class="token operator">:</span> owner<span class="token punctuation">,</span> r<span class="token operator">:</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> rawRef
  <span class="token comment">// 此处省略许多代码...</span>
  <span class="token keyword">const</span> oldRef <span class="token operator">=</span> oldRawRef <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldRawRef <span class="token keyword">as</span> VNodeNormalizedRefAtom<span class="token punctuation">)</span><span class="token punctuation">.</span>r
  <span class="token keyword">const</span> refs <span class="token operator">=</span> owner<span class="token punctuation">.</span>refs <span class="token operator">===</span> <span class="token constant">EMPTY_OBJ</span> <span class="token operator">?</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>refs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> owner<span class="token punctuation">.</span>refs
  <span class="token keyword">const</span> setupState <span class="token operator">=</span> owner<span class="token punctuation">.</span>setupState

  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRef <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> oldRef <span class="token operator">!==</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>oldRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      refs<span class="token punctuation">[</span>oldRef<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>setupState<span class="token punctuation">,</span> oldRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        setupState<span class="token punctuation">[</span>oldRef<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>oldRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldRef<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">FUNCTION_REF</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> refs<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _isString <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
    <span class="token keyword">const</span> _isRef <span class="token operator">=</span> <span class="token function">isRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_isString <span class="token operator">||</span> _isRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">doSet</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处省略许多代码...</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">(</span>doSet <span class="token keyword">as</span> SchedulerJob<span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token function">queuePostRenderEffect</span><span class="token punctuation">(</span>doSet<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">doSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此处省略许多代码...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于函数<code>setRef</code>，我们目前只需要知道主要做了<strong>3</strong>点即可：</p><ol><li>获取<code>ref</code>的代理对象；</li><li>找到<strong>旧虚拟Node</strong>对应的<code>ref</code>，如果存在且和<strong>新虚拟Node</strong>对应的<code>ref</code>不一致则置为<code>null</code>；</li><li>将新的<code>ref</code>代理对象赋值给<strong>新虚拟Node</strong>相应的属性。</li></ol><p>至于代码片段<strong>11</strong>呈现出来的关于<code>ref</code>的各种属性以及一些细节，在后续文章中合适的时机我们再继续探讨。</p><h2 id="写在最后" tabindex="-1"><a class="header-anchor" href="#写在最后" aria-hidden="true">#</a> 写在最后</h2><p>读完文章觉得有收获的朋友们，可以做下面几件事情支持：</p><ul><li>如果<code>点赞，点在看，转发</code>可以让文章帮助到更多需要帮助的人；</li><li>如果是微信公众号的作者，可以找我开通<code>白名单</code>，<code>转载</code>我的原创文章；</li></ul><p>最后，请朋友们关注我的<code>微信公众号: 杨艺韬</code>，可以获取我的最新动态。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yangyitao2@tal.com">yangyitao</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/vue3/07.%E6%95%85%E4%BA%8B%E8%A6%81%E4%BB%8EcreateApp%E8%AE%B2%E8%B5%B7.html" class="" aria-label="07.故事要从createApp讲起"><!--[--><!--]--> 07.故事要从createApp讲起 <!--[--><!--]--></a></span><span class="next"><a href="/vue3/09.%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%92%8C%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.html" class="" aria-label="09.组件渲染和更新流程"><!--[--><!--]--> 09.组件渲染和更新流程 <!--[--><!--]--></a></span></p></nav><!--[--><!--[--><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!-- <div style="width: 100%; text-align:center; margin-top: 60px; position: absolute; background: red">
        <a style="color:#a7a7a7; font-size:14px;" href="https://beian.miit.gov.cn">蜀ICP备2023033985号-3 &copy; 玄工科技（四川）有限责任公司</a>
      </div> --><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.03bf752b.js" defer></script>
  </body>
</html>
